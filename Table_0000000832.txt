OBJECT Table 832 Workflows Entries Buffer
{
  OBJECT-PROPERTIES
  {
    Date=09/19/18;
    Time=12:00:00 PM;
    Version List=NAVW113.00;
  }
  PROPERTIES
  {
    ReplicateData=No;
    CaptionML=[ENU=Workflows Entries Buffer;
               ESM=B£fer de movimientos de flujos de trabajo;
               FRC=Tampon des Çcritures de flux de travail;
               ENC=Workflows Entries Buffer];
  }
  FIELDS
  {
    { 1   ;   ;Created by Application;Option      ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Created by Application;
                                                              ESM=Creado por aplicaci¢n;
                                                              FRC=CrÇÇ par l'application;
                                                              ENC=Created by Application];
                                                   OptionCaptionML=[ENU=Microsoft Flow,Dynamics 365,Dynamics NAV;
                                                                    ESM=Microsoft Flow,Dynamics 365,Dynamics NAV;
                                                                    FRC=Microsoft Flow,Dynamics 365,Dynamics NAV;
                                                                    ENC=Microsoft Flow,Dynamics 365,Dynamics NAV];
                                                   OptionString=Microsoft Flow,Dynamics 365,Dynamics NAV }
    { 2   ;   ;Entry No.           ;Integer       ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Entry No.;
                                                              ESM=N.ß de movimiento;
                                                              FRC=N¯ Çcriture;
                                                              ENC=Entry No.] }
    { 3   ;   ;Workflow Step Instance ID;GUID     ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Workflow Step Instance ID;
                                                              ESM=Id. de instancia de paso de flujo de trabajo;
                                                              FRC=Code d'instance d'Çtape de flux de travail;
                                                              ENC=Workflow Step Instance ID] }
    { 4   ;   ;Record ID           ;RecordID      ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Record ID;
                                                              ESM=Id. de registro;
                                                              FRC=Code d'enregistrement;
                                                              ENC=Record ID] }
    { 5   ;   ;Initiated By User ID;Code50        ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Initiated By User ID;
                                                              ESM=Iniciado por id. de usuario;
                                                              FRC=InitiÇ par le code d'utilisateur;
                                                              ENC=Initiated By User ID] }
    { 6   ;   ;To Be Approved By User ID;Code50   ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=To Be Approved By User ID;
                                                              ESM=En espera de aprobaci¢n por id. de usuario;
                                                              FRC=∑ approuver par le code d'utilisateur;
                                                              ENC=To Be Approved By User ID] }
    { 7   ;   ;Date-Time Initiated ;DateTime      ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Date-Time Initiated;
                                                              ESM=Fecha/hora de inicio;
                                                              FRC=Date/Heure lancement;
                                                              ENC=Date-Time Initiated] }
    { 8   ;   ;Last Date-Time Modified;DateTime   ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Last Date-Time Modified;
                                                              ESM=Fecha/hora £lt. modificaci¢n;
                                                              FRC=Date-heure derniäre modification;
                                                              ENC=Last Date-Time Modified] }
    { 9   ;   ;Last Modified By User ID;Code50    ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Last Modified By User ID;
                                                              ESM=Èlt. modificaci¢n por id. usuario;
                                                              FRC=Derniäre modification par le code d'utilisateur;
                                                              ENC=Last Modified By User ID] }
    { 10  ;   ;Status              ;Option        ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Status;
                                                              ESM=Estado;
                                                              FRC=êtat;
                                                              ENC=Status];
                                                   OptionCaptionML=[ENU="Created,Open,Canceled,Rejected,Approved, ";
                                                                    ESM="Creado,Abierto,Cancelado,Rechazado,Aprobado, ";
                                                                    FRC="CrÇÇ,Ouvert,AnnulÇ,RejetÇ,ApprouvÇ, ";
                                                                    ENC="Created,Open,Cancelled,Rejected,Approved, "];
                                                   OptionString=[Created,Open,Canceled,Rejected,Approved, ] }
    { 11  ;   ;Response            ;Option        ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Response;
                                                              ESM=Respuesta;
                                                              FRC=RÇponse;
                                                              ENC=Response];
                                                   OptionCaptionML=[ENU="NotExpected,Pending,Cancel,Continue,Reject, ";
                                                                    ESM="Inesperado,Pendiente,Cancelar,Continuar,Rechazar, ";
                                                                    FRC="Inattendu,En attente,Annuler,Continuer,Rejeter, ";
                                                                    ENC="NotExpected,Pending,Cancel,Continue,Reject, "];
                                                   OptionString=[NotExpected,Pending,Cancel,Continue,Reject, ] }
    { 12  ;   ;Amount              ;Integer       ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Amount;
                                                              ESM=Importe;
                                                              FRC=Montant;
                                                              ENC=Amount] }
    { 13  ;   ;Due Date            ;Date          ;DataClassification=SystemMetadata;
                                                   CaptionML=[ENU=Due Date;
                                                              ESM=Fecha de vencimiento;
                                                              FRC=Date d'ÇchÇance;
                                                              ENC=Due Date] }
  }
  KEYS
  {
    {    ;Workflow Step Instance ID               ;Clustered=Yes }
    {    ;Entry No.                                }
  }
  FIELDGROUPS
  {
  }
  CODE
  {

    PROCEDURE AddWorkflowWebhookEntry@4(WorkflowWebhookEntry@1000 : Record 467;VAR WorkflowsCounter@1001 : Integer);
    BEGIN
      IF NOT GET(WorkflowWebhookEntry."Workflow Step Instance ID") THEN BEGIN
        WorkflowsCounter := WorkflowsCounter + 1;
        INIT;
        "Created by Application" := "Created by Application"::"Microsoft Flow";
        "Entry No." := WorkflowWebhookEntry."Entry No.";
        "Workflow Step Instance ID" := WorkflowWebhookEntry."Workflow Step Instance ID";
        "Record ID" := WorkflowWebhookEntry."Record ID";
        "Initiated By User ID" := WorkflowWebhookEntry."Initiated By User ID";
        "Date-Time Initiated" := WorkflowWebhookEntry."Date-Time Initiated";
        "Last Date-Time Modified" := WorkflowWebhookEntry."Last Date-Time Modified";
        "Last Modified By User ID" := WorkflowWebhookEntry."Last Modified By User ID";
        Response := WorkflowWebhookEntry.Response;
        Status := Status::" ";
        INSERT;
      END;
    END;

    PROCEDURE AddApprovalEntry@5(ApprovalEntry@1000 : Record 454;VAR WorkflowsCounter@1001 : Integer);
    VAR
      AzureAdMgt@1002 : Codeunit 6300;
    BEGIN
      IF NOT GET(ApprovalEntry."Workflow Step Instance ID") THEN BEGIN
        WorkflowsCounter := WorkflowsCounter + 1;
        INIT;
        IF AzureAdMgt.IsSaaS THEN
          "Created by Application" := "Created by Application"::"Dynamics 365"
        ELSE
          "Created by Application" := "Created by Application"::"Dynamics NAV";
        "Entry No." := WorkflowsCounter;
        "Workflow Step Instance ID" := ApprovalEntry."Workflow Step Instance ID";
        "Record ID" := ApprovalEntry."Record ID to Approve";
        "Initiated By User ID" := ApprovalEntry."Sender ID";
        "To Be Approved By User ID" := ApprovalEntry."Approver ID";
        "Date-Time Initiated" := ApprovalEntry."Date-Time Sent for Approval";
        "Last Date-Time Modified" := ApprovalEntry."Last Date-Time Modified";
        "Last Modified By User ID" := ApprovalEntry."Last Modified By User ID";
        Status := ApprovalEntry.Status;
        Response := Response::" ";
        "Due Date" := ApprovalEntry."Due Date";
        INSERT;
      END;
    END;

    [External]
    PROCEDURE RunWorkflowEntriesPage@1(RecordIDInput@1002 : RecordID;TableId@1008 : Integer;DocumentType@1007 : 'Quote,Order,Invoice,Credit Memo,Blanket Order,Return Order';DocumentNo@1000 : Code[20]);
    VAR
      ApprovalEntry@1006 : Record 454;
      WorkflowWebhookEntry@1001 : Record 467;
      Approvals@1004 : Page 832;
      WorkflowWebhookEntries@1003 : Page 830;
      ApprovalEntries@1005 : Page 658;
    BEGIN
      // if we are looking at a particular record, we want to see only record related workflow entries
      IF DocumentNo <> '' THEN BEGIN
        ApprovalEntry.SETRANGE("Record ID to Approve",RecordIDInput);
        WorkflowWebhookEntry.SETRANGE("Record ID",RecordIDInput);
        // if we have flows created by multiple applications, start generic page filtered for this RecordID
        IF ApprovalEntry.FINDFIRST AND WorkflowWebhookEntry.FINDFIRST THEN BEGIN
          Approvals.Setfilters(RecordIDInput);
          Approvals.RUN;
        END ELSE BEGIN
          // otherwise, open the page filtered for this record that corresponds to the type of the flow
          IF WorkflowWebhookEntry.FINDFIRST THEN BEGIN
            WorkflowWebhookEntries.Setfilters(RecordIDInput);
            WorkflowWebhookEntries.RUN;
            EXIT;
          END;

          IF ApprovalEntry.FINDFIRST THEN BEGIN
            ApprovalEntries.Setfilters(TableId,DocumentType,DocumentNo);
            ApprovalEntries.RUN;
            EXIT;
          END;

          // if no workflow exist, show (empty) joint workflows page
          Approvals.Setfilters(RecordIDInput);
          Approvals.RUN;
        END
      END ELSE
        // otherwise, open the page with all workflow entries
        Approvals.RUN;
    END;

    BEGIN
    END.
  }
}

