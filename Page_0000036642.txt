OBJECT Page 36642 Customer Credit FactBox
{
  OBJECT-PROPERTIES
  {
    Date=11/22/17;
    Time=12:00:00 PM;
    Version List=NAVNA11.00;
  }
  PROPERTIES
  {
    Editable=No;
    CaptionML=[ENU=Credit Information;
               ESM=Informaci¢n de crÇdito;
               FRC=Informations sur le crÇdit;
               ENC=Credit Information];
    SaveValues=Yes;
    SourceTable=Table18;
    PageType=CardPart;
    OnOpenPage=BEGIN
                 // Default the Aging Period to 30D
                 EVALUATE(AgingPeriod,'<30D>');
                 // Initialize Record Variables
                 LatestCustLedgerEntry.RESET;
                 LatestCustLedgerEntry.SETCURRENTKEY("Document Type","Customer No.","Posting Date");
                 LatestCustLedgerEntry.SETRANGE("Document Type",LatestCustLedgerEntry."Document Type"::Payment);
                 FOR I := 1 TO ARRAYLEN(CustLedgerEntry) DO BEGIN
                   CustLedgerEntry[I].RESET;
                   CustLedgerEntry[I].SETCURRENTKEY("Customer No.",Open,Positive,"Due Date");
                   CustLedgerEntry[I].SETRANGE(Open,TRUE);
                 END;
               END;

    OnAfterGetRecord=BEGIN
                       ChangeCustomer;
                       GetLatestPayment;
                       CalculateAging;
                     END;

  }
  CONTROLS
  {
    { 1900000001;0;Container;
                ContainerType=ContentArea }

    { 6   ;1   ;Field     ;
                ToolTipML=[ENU=Specifies the contact person for the customer record.;
                           ESM=Especifica la persona de contacto para el registro de cliente.;
                           FRC=SpÇcifie la personne Ö contacter pour l'enregistrement client.;
                           ENC=Specifies the contact person for the customer record.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=Contact }

    { 8   ;1   ;Field     ;
                ToolTipML=[ENU=Specifies the customer's phone number.;
                           ESM=Especifica el n£mero de telÇfono del cliente.;
                           FRC=SpÇcifie le numÇro de tÇlÇphone du client.;
                           ENC=Specifies the customer's phone number.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Phone No." }

    { 26  ;1   ;Field     ;
                ToolTipML=[ENU=Specifies the method you normally use to collect payment from this customer, such as bank transfer or check.;
                           ESM=Especifica el mÇtodo que usa normalmente para recopilar el pago de este cliente, como una transferencia bancaria o un cheque.;
                           FRC=SpÇcifie la mÇthode que vous utilisez normalement pour recevoir le paiement de ce client, par exemple un chäque ou un virement bancaire.;
                           ENC=Specifies the method you normally use to collect payment from this customer, such as bank transfer or cheque.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Collection Method" }

    { 1020000;1;Field     ;
                ToolTipML=[ENU=Specifies if the customer is blocked from posting.;
                           ESM=Especifica si el cliente est† bloqueado para realizar registros.;
                           FRC=SpÇcifie un blocage Çventuel du client pour le report.;
                           ENC=Specifies if the customer is blocked from posting.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=Blocked }

    { 14  ;1   ;Field     ;
                ToolTipML=[ENU=Specifies a formula that calculates the payment due date, payment discount date, and payment discount amount on sales documents. By default, the payment term from the customer card is entered.;
                           ESM=Especifica una f¢rmula que calcula la fecha de vencimiento, la fecha de descuento y el importe de descuento del pago en los documentos de ventas. De manera predeterminada, se introduce el tÇrmino de pago de la ficha cliente.;
                           FRC=SpÇcifie une formule qui calcule la date d'ÇchÇance du paiement, la date d'escompte de paiement et le montant d'escompte de paiement des documents de vente. Par dÇfaut, les modalitÇs de paiement de la fiche client sont renseignÇes.;
                           ENC=Specifies a formula that calculates the payment due date, payment discount date, and payment discount amount on sales documents. By default, the payment term from the customer card is entered.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Payment Terms Code" }

    { 28  ;1   ;Field     ;
                ToolTipML=[ENU=Specifies how the customer must pay for products on the sales document. By default, the payment method is copied from the customer card.;
                           ESM=Especifica c¢mo debe pagar el cliente los productos en el documento de ventas. De manera predeterminada, el mÇtodo de pago se copia de la ficha cliente.;
                           FRC=SpÇcifie comment le client doit payer les produits sur le document de vente. Par dÇfaut, le mode de paiement est copiÇ de la fiche client.;
                           ENC=Specifies how the customer must pay for products on the sales document. By default, the payment method is copied from the customer card.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Payment Method Code" }

    { 18  ;1   ;Field     ;
                CaptionML=[ENU=Latest Payment Date;
                           ESM=Èltima fecha pago;
                           FRC=Date du plus rÇcent paiement;
                           ENC=Latest Payment Date];
                ToolTipML=[ENU=Specifies the date when a payment was last made.;
                           ESM=Especifica la fecha en que se realiz¢ un pago por £ltima vez.;
                           FRC=SpÇcifie la date Ö laquelle un paiement a ÇtÇ effectuÇ pour la derniäre fois.;
                           ENC=Specifies the date when a payment was last made.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=LatestCustLedgerEntry."Posting Date";
                OnDrillDown=BEGIN
                              DrillDown(0);
                            END;
                             }

    { 21  ;1   ;Field     ;
                CaptionML=[ENU=Latest Payment Amount;
                           ESM=Èltimo importe pagos;
                           FRC=Montant du plus rÇcent paiement;
                           ENC=Latest Payment Amount];
                ToolTipML=[ENU=Specifies the last payment amount that was made.;
                           ESM=Especifica el importe del £ltimo pago.;
                           FRC=SpÇcifie le montant du dernier paiement qui a ÇtÇ effectuÇ.;
                           ENC=Specifies the last payment amount that was made.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=-LatestCustLedgerEntry."Amount (LCY)";
                OnDrillDown=BEGIN
                              DrillDown(0);
                            END;
                             }

    { 41  ;1   ;Field     ;
                ToolTipML=[ENU=Specifies the maximum credit (in $) that can be extended to the customer.;
                           ESM=Especifica el l°mite de crÇdito (en $) que puede concederse al cliente.;
                           FRC=SpÇcifie l'extension de crÇdit maximale (en $) pouvant àtre accordÇe au client.;
                           ENC=Specifies the maximum credit (in $) that can be extended to the customer.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Credit Limit (LCY)" }

    { 42  ;1   ;Field     ;
                ToolTipML=[ENU=Specifies the payment amount that the customer owes for completed sales. This value is also known as the customer's balance.;
                           ESM=Especifica el monto de pago que el cliente debe por las ventas completadas. Este valor tambiÇn se conoce como saldo del cliente.;
                           FRC=SpÇcifie le montant räglement que le client doit rÇgler pour les ventes rÇalisÇes. Cette valeur est Çgalement appelÇe le solde du client.;
                           ENC=Specifies the payment amount that the customer owes for completed sales. This value is also known as the customer's balance.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Balance (LCY)" }

    { 47  ;1   ;Field     ;
                CaptionML=[ENU=Difference;
                           ESM=Diferencia;
                           FRC=DiffÇrence;
                           ENC=Difference];
                ToolTipML=[ENU=Specifies the difference between the credit limit and the balance for the customer. The formula is credit limit minus balance.;
                           ESM=Especifica la diferencia entre el l°mite de crÇdito y el saldo del cliente. La f¢rmula es l°mite de crÇdito menos saldo.;
                           FRC=SpÇcifie la diffÇrence entre la limite de crÇdit et le solde pour le client. La formule est limite de crÇdit moins solde.;
                           ENC=Specifies the difference between the credit limit and the balance for the customer. The formula is credit limit minus balance.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Credit Limit (LCY)" - "Balance (LCY)" }

    { 39  ;1   ;Group     ;
                CaptionML=[ENU=Aging (showing days overdue);
                           ESM=AntigÅedad (d°as de retraso);
                           FRC=Chronologie (affichage des jours en souffrance);
                           ENC=Aging (showing days overdue)] }

    { 53  ;2   ;Field     ;
                CaptionML=[ENU=Not Yet Due;
                           ESM=Sin retraso;
                           FRC=Pas encore dñ;
                           ENC=Not Yet Due];
                ToolTipML=[ENU=Specifies amounts that are not yet due for payment.;
                           ESM=Especifica los importes cuyo pago a£n no ha vencido.;
                           FRC=SpÇcifie les montants dont le paiement n'est pas encore dñ.;
                           ENC=Specifies amounts that are not yet due for payment.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=CustLedgerEntry[1]."Remaining Amt. (LCY)";
                CaptionClass=FORMAT(AgingTitle[1]);
                OnDrillDown=BEGIN
                              DrillDown(1);
                            END;
                             }

    { 51  ;2   ;Field     ;
                CaptionML=[ENU=1-30 Days;
                           ESM=1-30 d°as;
                           FRC=1-30 jours;
                           ENC=1-30 Days];
                ToolTipML=[ENU=Specifies payments that are overdue between one and 30 days.;
                           ESM=Especifica los pagos que vencieron entre uno y 30 d°as atr†s.;
                           FRC=SpÇcifie les paiements Çchus depuis un Ö 30 jours.;
                           ENC=Specifies payments that are overdue between one and 30 days.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=CustLedgerEntry[2]."Remaining Amt. (LCY)";
                CaptionClass=FORMAT(AgingTitle[2]);
                OnDrillDown=BEGIN
                              DrillDown(2);
                            END;
                             }

    { 50  ;2   ;Field     ;
                CaptionML=[ENU=31-60 Days;
                           ESM=31-60 d°as;
                           FRC=31-60 jours;
                           ENC=31-60 Days];
                ToolTipML=[ENU=Specifies payments that are overdue between 30 and 60 days.;
                           ESM=Especifica los pagos que vencieron entre 30 y 60 d°as atr†s.;
                           FRC=SpÇcifie les paiements Çchus depuis 30 Ö 60 jours.;
                           ENC=Specifies payments that are overdue between 30 and 60 days.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=CustLedgerEntry[3]."Remaining Amt. (LCY)";
                CaptionClass=FORMAT(AgingTitle[3]);
                OnDrillDown=BEGIN
                              DrillDown(3);
                            END;
                             }

    { 45  ;2   ;Field     ;
                CaptionML=[ENU=Over 60 Days;
                           ESM=M†s de 60 d°as;
                           FRC=Plus de 60 jours;
                           ENC=Over 60 Days];
                ToolTipML=[ENU=Specifies payments that are overdue for more than 60 days.;
                           ESM=Especifica los pagos vencidos desde hace m†s de 60 d°as.;
                           FRC=SpÇcifie les paiements Çchus depuis plus de 60 jours.;
                           ENC=Specifies payments that are overdue for more than 60 days.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=CustLedgerEntry[4]."Remaining Amt. (LCY)";
                CaptionClass=FORMAT(AgingTitle[4]);
                OnDrillDown=BEGIN
                              DrillDown(4);
                            END;
                             }

  }
  CODE
  {
    VAR
      LatestCustLedgerEntry@1020000 : Record 21;
      CustLedgerEntry@1020001 : ARRAY [4] OF Record 21;
      AgingTitle@1020002 : ARRAY [4] OF Text[30];
      AgingPeriod@1020003 : DateFormula;
      I@1020004 : Integer;
      PeriodStart@1020005 : Date;
      PeriodEnd@1020006 : Date;
      Text002@1020009 : TextConst 'ENU=Not Yet Due;ESM=Sin retraso;FRC=Pas encore dñ;ENC=Not Yet Due';
      Text003@1020010 : TextConst 'ENU=Over %1 Days;ESM=M†s de %1 d°as;FRC=Plus de %1 jours;ENC=Over %1 Days';
      Text004@1020011 : TextConst 'ENU=%1-%2 Days;ESM=%1-%2 d°as;FRC=%1 Ö %2 jours;ENC=%1-%2 Days';

    [External]
    PROCEDURE CalculateAgingForPeriod@7(PeriodBeginDate@1020000 : Date;PeriodEndDate@1020001 : Date;Index@1020002 : Integer);
    VAR
      CustLedgerEntry2@1020005 : Record 21;
      NumDaysToBegin@1020003 : Integer;
      NumDaysToEnd@1020004 : Integer;
    BEGIN
      // Calculate the Aged Balance for a particular Date Range
      IF PeriodEndDate = 0D THEN
        CustLedgerEntry[Index].SETFILTER("Due Date",'%1..',PeriodBeginDate)
      ELSE
        CustLedgerEntry[Index].SETRANGE("Due Date",PeriodBeginDate,PeriodEndDate);

      CustLedgerEntry2.COPY(CustLedgerEntry[Index]);
      CustLedgerEntry[Index]."Remaining Amt. (LCY)" := 0;
      IF CustLedgerEntry2.FIND('-') THEN
        REPEAT
          CustLedgerEntry2.CALCFIELDS("Remaining Amt. (LCY)");
          CustLedgerEntry[Index]."Remaining Amt. (LCY)" :=
            CustLedgerEntry[Index]."Remaining Amt. (LCY)" + CustLedgerEntry2."Remaining Amt. (LCY)";
        UNTIL CustLedgerEntry2.NEXT = 0;

      IF PeriodBeginDate <> 0D THEN
        NumDaysToBegin := WORKDATE - PeriodBeginDate;
      IF PeriodEndDate <> 0D THEN
        NumDaysToEnd := WORKDATE - PeriodEndDate;
      IF PeriodEndDate = 0D THEN
        AgingTitle[Index] := Text002
      ELSE
        IF PeriodBeginDate = 0D THEN
          AgingTitle[Index] := STRSUBSTNO(Text003,NumDaysToEnd - 1)
        ELSE
          AgingTitle[Index] := STRSUBSTNO(Text004,NumDaysToEnd,NumDaysToBegin);
    END;

    [External]
    PROCEDURE CalculateAging@5();
    BEGIN
      // Calculate the Entire Aging (four Periods)
      FOR I := 1 TO ARRAYLEN(CustLedgerEntry) DO BEGIN
        CASE I OF
          1:
            BEGIN
              PeriodEnd := 0D;
              PeriodStart := WORKDATE;
            END;
          ARRAYLEN(CustLedgerEntry):
            BEGIN
              PeriodEnd := PeriodStart - 1;
              PeriodStart := 0D;
            END;
          ELSE
            BEGIN
            PeriodEnd := PeriodStart - 1;
            PeriodStart := CALCDATE('-' + FORMAT(AgingPeriod),PeriodStart);
          END;
        END;
        CalculateAgingForPeriod(PeriodStart,PeriodEnd,I);
      END;
    END;

    [External]
    PROCEDURE GetLatestPayment@6();
    BEGIN
      // Find the Latest Payment
      IF LatestCustLedgerEntry.FINDLAST THEN
        LatestCustLedgerEntry.CALCFIELDS("Amount (LCY)")
      ELSE
        LatestCustLedgerEntry.INIT;
    END;

    [External]
    PROCEDURE ChangeCustomer@2();
    BEGIN
      // Change the Customer Filters
      LatestCustLedgerEntry.SETRANGE("Customer No.","No.");
      FOR I := 1 TO ARRAYLEN(CustLedgerEntry) DO
        CustLedgerEntry[I].SETRANGE("Customer No.","No.");
    END;

    [External]
    PROCEDURE DrillDown@11(Index@1020000 : Integer);
    BEGIN
      IF Index = 0 THEN
        PAGE.RUNMODAL(PAGE::"Customer Ledger Entries",LatestCustLedgerEntry)
      ELSE
        PAGE.RUNMODAL(PAGE::"Customer Ledger Entries",CustLedgerEntry[Index]);
    END;

    BEGIN
    END.
  }
}

