OBJECT Page 2196 O365 Link to Financials
{
  OBJECT-PROPERTIES
  {
    Date=11/27/18;
    Time=11:10:47 PM;
    Version List=;
  }
  PROPERTIES
  {
    CaptionML=ENU=O365 Link to Financials;
    PageType=CardPart;
    OnInit=BEGIN
             Initialize;
           END;

  }
  CONTROLS
  {
    { 1   ;    ;Container ;
                ContainerType=ContentArea }

    { 3   ;1   ;Field     ;
                Name=StayTunedLbl;
                CaptionML=ENU=We're building the Microsoft Invoicing web experience. Stay tuned!;
                ToolTipML=ENU=Specifies that we're building the Microsoft Invoicing web experience.;
                ApplicationArea=#Invoicing;
                Visible=ShowLabel;
                Editable=FALSE;
                Style=StrongAccent;
                StyleExpr=TRUE }

    { 4   ;1   ;Field     ;
                Name=TryOutLbl;
                CaptionML=ENU=Try out the Dynamics 365 evaluation company.;
                ToolTipML=ENU=Specifies to try out the Business Central evaluation company;
                ApplicationArea=#Invoicing;
                Visible=ShowLabel;
                Editable=FALSE;
                Style=StrongAccent;
                StyleExpr=TRUE }

    { 2   ;1   ;Field     ;
                Name=LinkToFinancials;
                ApplicationArea=#Invoicing;
                SourceExpr=TryD365FinancialsLbl;
                Visible=ShowLabel;
                Editable=FALSE;
                OnDrillDown=BEGIN
                              ChangeToEvaluationCompany;
                            END;

                ShowCaption=No }

  }
  CODE
  {
    VAR
      IdentityManagement@1001 : Codeunit 9801;
      TryD365FinancialsLbl@1004 : TextConst 'ENU=Click here to change company.';
      SignOutToStartTrialMsg@1003 : TextConst 'ENU=We''re glad you''ve chosen to explore Dynamics 365 Business Central!\\To get going, please sign out and sign in again.';
      EvaluationCompanyDoesNotExistsMsg@1002 : TextConst 'ENU=We''re unable to start Dynamics 365 Business Central because your evaluation company is not yet set up.';
      ShowLabel@1000 : Boolean;

    LOCAL PROCEDURE Initialize@6();
    VAR
      PermissionManager@1000 : Codeunit 9002;
      ApplicationAreaMgmt@1004 : Codeunit 9178;
      IsFinApp@1003 : Boolean;
      IsSaas@1001 : Boolean;
      IsInvAppAreaSet@1002 : Boolean;
    BEGIN
      IsFinApp := IdentityManagement.IsFinAppId;
      IsSaas := PermissionManager.SoftwareAsAService;
      IsInvAppAreaSet := ApplicationAreaMgmt.IsInvoicingOnlyEnabled AND (NOT ApplicationAreaMgmt.IsAllDisabled);

      ShowLabel := IsFinApp AND IsSaas AND IsInvAppAreaSet;
    END;

    LOCAL PROCEDURE ChangeToEvaluationCompany@7();
    VAR
      UserPersonalization@1001 : Record 2000000073;
      Company@1000 : Record 2000000006;
    BEGIN
      Company.SETRANGE("Evaluation Company",TRUE);
      IF Company.FINDFIRST THEN BEGIN
        UserPersonalization.GET(USERSECURITYID);
        UserPersonalization.VALIDATE(Company,Company.Name);
        UserPersonalization.MODIFY(TRUE);
        MESSAGE(SignOutToStartTrialMsg)
      END ELSE
        MESSAGE(EvaluationCompanyDoesNotExistsMsg);
    END;

    BEGIN
    END.
  }
}

