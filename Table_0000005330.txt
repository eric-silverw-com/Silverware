OBJECT Table 5330 CRM Connection Setup
{
  OBJECT-PROPERTIES
  {
    Date=11/27/18;
    Time=11:14:50 PM;
    Version List=;
  }
  PROPERTIES
  {
    Permissions=TableData 1261=rimd;
    CaptionML=ENU=Microsoft Dynamics 365 Connection Setup;
  }
  FIELDS
  {
    { 1   ;   ;Primary Key         ;Code20        ;CaptionML=ENU=Primary Key }
    { 2   ;   ;Server Address      ;Text250       ;OnValidate=BEGIN
                                                                CRMIntegrationManagement.CheckModifyCRMConnectionURL("Server Address");

                                                                IF STRPOS("Server Address",'.dynamics.com') > 0 THEN
                                                                  "Authentication Type" := "Authentication Type"::Office365
                                                                ELSE
                                                                  "Authentication Type" := "Authentication Type"::AD;
                                                                IF "User Name" <> '' THEN
                                                                  UpdateConnectionString;
                                                              END;

                                                   CaptionML=ENU=Dynamics 365 for Sales URL }
    { 3   ;   ;User Name           ;Text250       ;OnValidate=BEGIN
                                                                "User Name" := DELCHR("User Name",'<>');
                                                                CheckUserName;
                                                                UpdateDomainName;
                                                                UpdateConnectionString;
                                                              END;

                                                   DataClassification=EndUserIdentifiableInformation;
                                                   CaptionML=ENU=User Name }
    { 4   ;   ;User Password Key   ;GUID          ;DataClassification=EndUserPseudonymousIdentifiers;
                                                   CaptionML=ENU=User Password Key }
    { 5   ;   ;Last Update Invoice Entry No.;Integer;
                                                   CaptionML=ENU=Last Update Invoice Entry No.;
                                                   Editable=No }
    { 59  ;   ;Restore Connection  ;Boolean       ;CaptionML=ENU=Restore Connection }
    { 60  ;   ;Is Enabled          ;Boolean       ;OnValidate=BEGIN
                                                                EnableCRMConnection;
                                                                UpdateIsEnabledState;
                                                                RefreshDataFromCRM;
                                                              END;

                                                   CaptionML=ENU=Is Enabled }
    { 61  ;   ;Is User Mapping Required;Boolean   ;OnValidate=BEGIN
                                                                UpdateAllConnectionRegistrations;
                                                                UpdateIsEnabledState;
                                                              END;

                                                   CaptionML=ENU=Business Central Users Must Map to Dynamics 365 for Sales Users }
    { 62  ;   ;Is User Mapped To CRM User;Boolean ;CaptionML=ENU=Is User Mapped To CRM User }
    { 63  ;   ;CRM Version         ;Text30        ;CaptionML=ENU=CRM Version }
    { 66  ;   ;Is S.Order Integration Enabled;Boolean;
                                                   OnValidate=BEGIN
                                                                IF "Is S.Order Integration Enabled" THEN
                                                                  IF CONFIRM(STRSUBSTNO(SetCRMSOPEnableQst,PRODUCTNAME.SHORT)) THEN
                                                                    SetCRMSOPEnabled
                                                                  ELSE
                                                                    ERROR('')
                                                                ELSE
                                                                  SetCRMSOPDisabled;
                                                                RefreshDataFromCRM;

                                                                IF "Is S.Order Integration Enabled" THEN
                                                                  MESSAGE(SetCRMSOPEnableConfirmMsg,CRMProductName.SHORT)
                                                                ELSE
                                                                  MESSAGE(SetCRMSOPDisableConfirmMsg,CRMProductName.SHORT);
                                                              END;

                                                   CaptionML=ENU=Is S.Order Integration Enabled }
    { 67  ;   ;Is CRM Solution Installed;Boolean  ;CaptionML=ENU=Is CRM Solution Installed }
    { 68  ;   ;Is Enabled For User ;Boolean       ;CaptionML=ENU=Is Enabled For User }
    { 69  ;   ;Dynamics NAV URL    ;Text250       ;OnValidate=BEGIN
                                                                CRMIntegrationManagement.SetCRMNAVConnectionUrl("Dynamics NAV URL");
                                                              END;

                                                   CaptionML=ENU=Dynamics NAV URL }
    { 70  ;   ;Dynamics NAV OData URL;Text250     ;OnValidate=BEGIN
                                                                CRMIntegrationManagement.SetCRMNAVODataUrlCredentials(
                                                                  "Dynamics NAV OData URL","Dynamics NAV OData Username","Dynamics NAV OData Accesskey");
                                                              END;

                                                   CaptionML=ENU=Dynamics NAV OData URL }
    { 71  ;   ;Dynamics NAV OData Username;Text250;OnValidate=VAR
                                                                User@1000 : Record 2000000120;
                                                              BEGIN
                                                                User.SETRANGE("User Name","Dynamics NAV OData Username");
                                                                IF User.FINDFIRST THEN
                                                                  UpdateODataUsernameAccesskey(User)
                                                                ELSE BEGIN
                                                                  "Dynamics NAV OData Username" := '';
                                                                  "Dynamics NAV OData Accesskey" := '';
                                                                END;
                                                              END;

                                                   OnLookup=VAR
                                                              User@1000 : Record 2000000120;
                                                            BEGIN
                                                              IF PAGE.RUNMODAL(PAGE::Users,User) = ACTION::LookupOK THEN
                                                                UpdateODataUsernameAccesskey(User);
                                                            END;

                                                   DataClassification=EndUserIdentifiableInformation;
                                                   CaptionML=ENU=Dynamics NAV OData Username }
    { 72  ;   ;Dynamics NAV OData Accesskey;Text250;
                                                   CaptionML=ENU=Dynamics NAV OData Accesskey }
    { 75  ;   ;Default CRM Price List ID;GUID     ;CaptionML=ENU=Default CRM Price List ID }
    { 76  ;   ;Proxy Version       ;Integer       ;OnValidate=BEGIN
                                                                UpdateConnectionString;
                                                              END;

                                                   DataClassification=SystemMetadata;
                                                   CaptionML=ENU=Proxy Version }
    { 80  ;   ;Auto Create Sales Orders;Boolean   ;OnValidate=VAR
                                                                CRMSetupDefaults@1000 : Codeunit 5334;
                                                              BEGIN
                                                                IF "Auto Create Sales Orders" THEN
                                                                  CRMSetupDefaults.RecreateAutoCreateSalesOrdersJobQueueEntry(DoReadCRMData)
                                                                ELSE
                                                                  CRMSetupDefaults.DeleteAutoCreateSalesOrdersJobQueueEntry;
                                                              END;

                                                   CaptionML=ENU=Automatically Create Sales Orders }
    { 118 ;   ;CurrencyDecimalPrecision;Integer   ;CaptionML=ENU=Currency Decimal Precision;
                                                   Description=Number of decimal places that can be used for currency. }
    { 124 ;   ;BaseCurrencyId      ;GUID          ;TableRelation="CRM Transactioncurrency".TransactionCurrencyId;
                                                   ExternalAccess=Insert;
                                                   CaptionML=ENU=Currency;
                                                   Description=Unique identifier of the base currency of the organization. }
    { 133 ;   ;BaseCurrencyPrecision;Integer      ;ExternalAccess=Read;
                                                   CaptionML=ENU=Base Currency Precision;
                                                   MinValue=0;
                                                   MaxValue=4;
                                                   Description=Number of decimal places that can be used for the base currency. }
    { 134 ;   ;BaseCurrencySymbol  ;Text5         ;ExternalAccess=Read;
                                                   CaptionML=ENU=Base Currency Symbol;
                                                   Description=Symbol used for the base currency. }
    { 135 ;   ;Authentication Type ;Option        ;OnValidate=BEGIN
                                                                IF xRec."Authentication Type" <> "Authentication Type" THEN
                                                                  VALIDATE("Is User Mapping Required",FALSE);
                                                                CASE "Authentication Type" OF
                                                                  "Authentication Type"::Office365:
                                                                    Domain := '';
                                                                  "Authentication Type"::AD:
                                                                    UpdateDomainName;
                                                                END;
                                                                UpdateConnectionString;
                                                              END;

                                                   CaptionML=ENU=Authentication Type;
                                                   OptionCaptionML=ENU=Office365,AD,IFD,OAuth;
                                                   OptionString=Office365,AD,IFD,OAuth }
    { 136 ;   ;Connection String   ;Text250       ;CaptionML=ENU=Connection String }
    { 137 ;   ;Domain              ;Text250       ;DataClassification=OrganizationIdentifiableInformation;
                                                   CaptionML=ENU=Domain;
                                                   Editable=No }
    { 138 ;   ;Server Connection String;BLOB      ;CaptionML=ENU=Server Connection String }
    { 139 ;   ;Disable Reason      ;Text250       ;CaptionML=ENU=Disable Reason }
  }
  KEYS
  {
    {    ;Primary Key                             ;Clustered=Yes }
  }
  FIELDGROUPS
  {
  }
  CODE
  {
    VAR
      CRMIntegrationManagement@1055 : Codeunit 5330;
      CantRegisterDisabledConnectionErr@1001 : TextConst 'ENU=A disabled connection cannot be registered.';
      ConnectionErr@1009 : TextConst '@@@=%1 Error message from the provider (.NET exception message);ENU=The connection setup cannot be validated. Verify the settings and try again.\Detailed error description: %1.';
      ConnectionStringFormatTok@1000 : TextConst '@@@={Locked};ENU="Url=%1; UserName=%2; Password=%3; ProxyVersion=%4; %5"';
      ConnectionSuccessMsg@1008 : TextConst 'ENU=The connection test was successful. The settings are valid.';
      ConnectionSuccessNotEnabledForCurrentUserMsg@1007 : TextConst '@@@="%1 = Current User ID, %2 - product name, %3 = CRM product name";ENU=The connection test was successful. The settings are valid.\\However, because the %2 Users Must Map to %3 Users field is set, %3 integration is not enabled for %1.';
      CannotResolveUserFromConnectionSetupErr@1013 : TextConst '@@@="%1 = CRM product name";ENU=The %1 user that is specified in the CRM connection setup does not exist.';
      DetailsMissingErr@1006 : TextConst '@@@="%1 = CRM product name";ENU=A %1 URL, user name and password are required to enable a connection.';
      MissingUsernameTok@1003 : TextConst '@@@={Locked};ENU={USER}';
      MissingPasswordTok@1005 : TextConst '@@@={Locked};ENU={PASSWORD}';
      ProcessDialogMapTitleMsg@1011 : TextConst '@@@=@1 Progress dialog map no.;ENU=Synchronizing @1';
      UserCRMSetupTxt@1015 : TextConst 'ENU=User CRM Setup';
      CannotConnectCRMErr@1014 : TextConst '@@@="%1 - email of the user, %2 = CRM product name";ENU=The system is unable to connect to %2, and the connection has been disabled. Verify the credentials of the user account %1, and then enable the connection again in the Microsoft Dynamics 365 Connection Setup window.';
      LCYMustMatchBaseCurrencyErr@1016 : TextConst '@@@=%1,%2 - ISO currency codes;ENU=$ Code %1 does not match ISO Currency Code %2 of the CRM base currency.';
      UserNameMustIncludeDomainErr@1020 : TextConst 'ENU=The user name must include the domain when the authentication type is set to Active Directory.';
      UserNameMustBeEmailErr@1021 : TextConst 'ENU=The user name must be a valid email address when the authentication type is set to Office 365.';
      ConnectionStringPwdPlaceHolderMissingErr@1028 : TextConst 'ENU=The connection string must include the password placeholder {PASSWORD}.';
      CannotDisableSalesOrderIntErr@1010 : TextConst 'ENU=You cannot disable CRM sales order integration when a CRM sales order has the Submitted status.';
      SetCRMSOPEnableQst@1018 : TextConst '@@@=%1 - product name;ENU=Enabling Sales Order Integration will allow you to create %1 Sales Orders from Dynamics CRM.\\To enable this setting, you must provide Dynamics CRM administrator credentials (user name and password).\\Do you want to continue?';
      SetCRMSOPEnableConfirmMsg@1017 : TextConst '@@@="%1 = CRM product name";ENU=Sales Order Integration with %1 is enabled.';
      SetCRMSOPDisableConfirmMsg@1019 : TextConst '@@@="%1 = CRM product name";ENU=Sales Order Integration with %1 is disabled.';
      CRMProductName@1002 : Codeunit 5344;

    [External]
    PROCEDURE CountCRMJobQueueEntries@30(VAR ActiveJobs@1000 : Integer;VAR TotalJobs@1001 : Integer);
    VAR
      JobQueueEntry@1002 : Record 472;
    BEGIN
      IF NOT "Is Enabled" THEN BEGIN
        TotalJobs := 0;
        ActiveJobs := 0;
      END ELSE BEGIN
        IF "Is CRM Solution Installed" THEN
          JobQueueEntry.SETFILTER("Object ID to Run",GetJobQueueEntriesObjectIDToRunFilter)
        ELSE
          JobQueueEntry.SETRANGE("Object ID to Run",CODEUNIT::"Integration Synch. Job Runner");
        TotalJobs := JobQueueEntry.COUNT;

        JobQueueEntry.SETFILTER(Status,'%1|%2',JobQueueEntry.Status::Ready,JobQueueEntry.Status::"In Process");
        ActiveJobs := JobQueueEntry.COUNT;
      END;
    END;

    [External]
    PROCEDURE HasPassword@8() : Boolean;
    BEGIN
      EXIT(GetPassword <> '');
    END;

    [External]
    PROCEDURE SetPassword@1(PasswordText@1000 : Text);
    VAR
      ServicePassword@1002 : Record 1261;
    BEGIN
      IF ISNULLGUID("User Password Key") OR NOT ServicePassword.GET("User Password Key") THEN BEGIN
        ServicePassword.SavePassword(PasswordText);
        ServicePassword.INSERT(TRUE);
        "User Password Key" := ServicePassword.Key;
      END ELSE BEGIN
        ServicePassword.SavePassword(PasswordText);
        ServicePassword.MODIFY;
      END;
    END;

    PROCEDURE UpdateAllConnectionRegistrations@4();
    BEGIN
      UNREGISTERTABLECONNECTION(TABLECONNECTIONTYPE::CRM,GETDEFAULTTABLECONNECTION(TABLECONNECTIONTYPE::CRM));

      UnregisterConnection;
      IF "Is Enabled" THEN
        RegisterUserConnection;
    END;

    [External]
    PROCEDURE UpdateIsEnabledState@34();
    BEGIN
      "Is User Mapped To CRM User" := IsCurrentUserMappedToCrmSystemUser;
      "Is Enabled For User" :=
        "Is Enabled" AND
        ((NOT "Is User Mapping Required") OR ("Is User Mapping Required" AND "Is User Mapped To CRM User"));
    END;

    LOCAL PROCEDURE UpdateODataUsernameAccesskey@43(User@1000 : Record 2000000120);
    VAR
      IdentityManagement@1001 : Codeunit 9801;
    BEGIN
      "Dynamics NAV OData Username" := User."User Name";
      "Dynamics NAV OData Accesskey" := IdentityManagement.GetWebServicesKey(User."User Security ID");

      CRMIntegrationManagement.SetCRMNAVODataUrlCredentials(
        "Dynamics NAV OData URL","Dynamics NAV OData Username","Dynamics NAV OData Accesskey");
    END;

    [External]
    PROCEDURE RegisterConnection@17();
    BEGIN
      IF NOT HASTABLECONNECTION(TABLECONNECTIONTYPE::CRM,"Primary Key") THEN
        RegisterConnectionWithName("Primary Key");
    END;

    [External]
    PROCEDURE RegisterConnectionWithName@12(ConnectionName@1000 : Text);
    BEGIN
      REGISTERTABLECONNECTION(TABLECONNECTIONTYPE::CRM,ConnectionName,GetConnectionStringWithPassword);
      SETDEFAULTTABLECONNECTION(TABLECONNECTIONTYPE::CRM,GetDefaultCRMConnection(ConnectionName));
    END;

    [External]
    PROCEDURE UnregisterConnection@5() : Boolean;
    BEGIN
      EXIT(UnregisterConnectionWithName("Primary Key"));
    END;

    [TryFunction]
    [External]
    PROCEDURE UnregisterConnectionWithName@20(ConnectionName@1000 : Text);
    BEGIN
      UNREGISTERTABLECONNECTION(TABLECONNECTIONTYPE::CRM,ConnectionName);
    END;

    LOCAL PROCEDURE ConstructConnectionStringWithCalledID@16(CallerID@1000 : Text) : Text;
    BEGIN
      EXIT(GetConnectionStringWithPassword + 'CallerID=' + CallerID);
    END;

    PROCEDURE GetConnectionStringWithPassword@53() ConnectionString : Text;
    VAR
      PasswordPlaceHolderPos@1000 : Integer;
    BEGIN
      ConnectionString := GetConnectionString;
      IF ConnectionString = '' THEN
        ConnectionString := UpdateConnectionString;
      IF "User Name" = '' THEN
        EXIT(ConnectionString);
      PasswordPlaceHolderPos := STRPOS(ConnectionString,MissingPasswordTok);
      ConnectionString :=
        COPYSTR(ConnectionString,1,PasswordPlaceHolderPos - 1) + GetPassword +
        COPYSTR(ConnectionString,PasswordPlaceHolderPos + STRLEN(MissingPasswordTok));
    END;

    PROCEDURE RegisterUserConnection@6() ConnectionName : Text;
    VAR
      SyncUser@1000 : Record 2000000120;
      CallerID@1001 : GUID;
    BEGIN
      RegisterConnection;
      SyncUser."User Name" := COPYSTR("User Name",1,MAXSTRLEN(SyncUser."User Name"));
      SyncUser."Authentication Email" := "User Name";
      IF NOT TryGetSystemUserId(SyncUser,CallerID) THEN BEGIN
        UnregisterConnection;
        VALIDATE("Is Enabled",FALSE);
        VALIDATE("Is User Mapping Required",FALSE);
        MODIFY;
        ShowError(UserCRMSetupTxt,STRSUBSTNO(CannotConnectCRMErr,"User Name",CRMProductName.SHORT));
      END ELSE
        ConnectionName := RegisterAuthUserConnection;
    END;

    LOCAL PROCEDURE RegisterAuthUserConnection@42() ConnectionName : Text;
    VAR
      User@1001 : Record 2000000120;
      CallerID@1000 : GUID;
    BEGIN
      IF GetUser(User) THEN
        IF NOT TryGetSystemUserId(User,CallerID) THEN BEGIN
          UnregisterConnection;
          ShowError(UserCRMSetupTxt,STRSUBSTNO(CannotConnectCRMErr,User."Authentication Email"));
        END ELSE
          IF NOT ISNULLGUID(CallerID) THEN BEGIN
            UnregisterConnection;
            ConnectionName := RegisterConnectionWithCallerID(CallerID);
          END;
    END;

    LOCAL PROCEDURE RegisterConnectionWithCallerID@11(CallerID@1000 : Text) ConnectionName : Text;
    BEGIN
      IF "Is Enabled" THEN BEGIN
        REGISTERTABLECONNECTION(TABLECONNECTIONTYPE::CRM,"Primary Key",ConstructConnectionStringWithCalledID(CallerID));
        ConnectionName := "Primary Key";
        IF "Primary Key" = '' THEN BEGIN
          ConnectionName := GetDefaultCRMConnection("Primary Key");
          SETDEFAULTTABLECONNECTION(TABLECONNECTIONTYPE::CRM,ConnectionName);
        END;
      END ELSE
        ShowError(UserCRMSetupTxt,CantRegisterDisabledConnectionErr);
    END;

    [External]
    PROCEDURE GetIntegrationUserID@7() IntegrationUserID : GUID;
    VAR
      CRMSystemuser@1001 : Record 5340;
    BEGIN
      GET;
      TESTFIELD("Is Enabled");
      FilterCRMSystemUser(CRMSystemuser);
      IF CRMSystemuser.FINDFIRST THEN
        IntegrationUserID := CRMSystemuser.SystemUserId;
      IF ISNULLGUID(IntegrationUserID) THEN
        ShowError(UserCRMSetupTxt,STRSUBSTNO(CannotResolveUserFromConnectionSetupErr,CRMProductName.SHORT));
    END;

    LOCAL PROCEDURE GetPassword@2() : Text;
    VAR
      ServicePassword@1000 : Record 1261;
    BEGIN
      IF NOT ISNULLGUID("User Password Key") THEN
        IF ServicePassword.GET("User Password Key") THEN
          EXIT(ServicePassword.GetPassword);
    END;

    LOCAL PROCEDURE GetUser@51(VAR User@1000 : Record 2000000120) : Boolean;
    BEGIN
      IF User.GET(DATABASE.USERSECURITYID) THEN
        EXIT(TRUE);
      User.RESET;
      User.SETRANGE("Windows Security ID",SID);
      EXIT(User.FINDFIRST);
    END;

    LOCAL PROCEDURE GetUserName@60() UserName : Text;
    BEGIN
      IF "User Name" = '' THEN
        UserName := MissingUsernameTok
      ELSE
        UserName := COPYSTR("User Name",STRPOS("User Name",'\') + 1);
    END;

    PROCEDURE GetJobQueueEntriesObjectIDToRunFilter@58() : Text;
    BEGIN
      EXIT(
        STRSUBSTNO(
          '%1|%2|%3',
          CODEUNIT::"Integration Synch. Job Runner",
          CODEUNIT::"CRM Statistics Job",
          CODEUNIT::"Auto Create Sales Orders"));
    END;

    PROCEDURE PerformTestConnection@19();
    BEGIN
      VerifyTestConnection;

      IF "Is User Mapping Required" AND "Is Enabled" THEN
        IF NOT IsCurrentUserMappedToCrmSystemUser THEN BEGIN
          MESSAGE(ConnectionSuccessNotEnabledForCurrentUserMsg,USERID,PRODUCTNAME.SHORT,CRMProductName.SHORT);
          EXIT;
        END;

      MESSAGE(ConnectionSuccessMsg);
    END;

    PROCEDURE VerifyTestConnection@21() : Boolean;
    BEGIN
      IF ("Server Address" = '') OR ("User Name" = '') OR NOT HasPassword THEN
        ERROR(DetailsMissingErr,CRMProductName.SHORT);

      CRMIntegrationManagement.ClearState;

      IF NOT TestConnection THEN
        ERROR(ConnectionErr,CRMIntegrationManagement.GetLastErrorMessage);

      EXIT(TRUE);
    END;

    [External]
    PROCEDURE TestConnection@9() Success : Boolean;
    VAR
      TestConnectionName@1000 : Text;
    BEGIN
      TestConnectionName := FORMAT(CREATEGUID);
      UnregisterConnectionWithName(TestConnectionName);
      RegisterConnectionWithName(TestConnectionName);
      SETDEFAULTTABLECONNECTION(
        TABLECONNECTIONTYPE::CRM,GetDefaultCRMConnection(TestConnectionName),TRUE);
      Success := TryReadSystemUsers;

      UnregisterConnectionWithName(TestConnectionName);
    END;

    [TryFunction]
    PROCEDURE TryReadSystemUsers@14();
    VAR
      CRMSystemuser@1000 : Record 5340;
    BEGIN
      CRMSystemuser.FINDFIRST;
    END;

    LOCAL PROCEDURE CreateOrganizationService@10(VAR CRMHelper@1000 : DotNet "'Microsoft.Dynamics.Nav.CrmCustomizationHelper, Version=13.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.CrmCustomizationHelper.CrmHelper");
    BEGIN
      CRMHelper := CRMHelper.CrmHelper(GetConnectionStringWithPassword);
    END;

    [TryFunction]
    LOCAL PROCEDURE GetCrmVersion@15(VAR Version@1003 : Text);
    VAR
      CRMHelper@1004 : DotNet "'Microsoft.Dynamics.Nav.CrmCustomizationHelper, Version=13.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.CrmCustomizationHelper.CrmHelper";
    BEGIN
      IF NOT DoReadCRMData THEN
        EXIT;

      Version := '';
      CreateOrganizationService(CRMHelper);
      Version := CRMHelper.GetConnectedCrmVersion;
    END;

    [External]
    PROCEDURE IsVersionValid@33() : Boolean;
    VAR
      Version@1000 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Version";
    BEGIN
      IF "CRM Version" <> '' THEN
        IF Version.TryParse("CRM Version",Version) THEN
          EXIT((Version.Major > 6) AND NOT ((Version.Major = 7) AND (Version.Minor = 1)));
      EXIT(FALSE);
    END;

    PROCEDURE IsCurrentUserMappedToCrmSystemUser@13() : Boolean;
    VAR
      User@1000 : Record 2000000120;
      CRMSystemUserId@1002 : GUID;
    BEGIN
      IF GetUser(User) THEN
        IF TryGetSystemUserId(User,CRMSystemUserId) THEN
          EXIT(NOT ISNULLGUID(CRMSystemUserId));
    END;

    [TryFunction]
    LOCAL PROCEDURE TryGetSystemUserId@18(User@1003 : Record 2000000120;VAR SystemUserId@1001 : GUID);
    VAR
      CRMSystemuser@1002 : Record 5340;
    BEGIN
      // Returns FALSE if CRMSystemuser.FINDFIRST throws an exception, e.g. due to wrong credentials;
      // Returns TRUE regardless of CRMSystemuser.FINDFIRST result,
      // further check of ISNULLGUID(SystemUserId) is required to identify if the user exists
      CLEAR(SystemUserId);
      IF "Is Enabled" THEN
        IF "Is User Mapping Required" THEN BEGIN
          CRMSystemuser.SETRANGE(IsDisabled,FALSE);
          CASE "Authentication Type" OF
            "Authentication Type"::AD,"Authentication Type"::IFD:
              CRMSystemuser.SETRANGE(DomainName,User."User Name");
            "Authentication Type"::Office365,"Authentication Type"::OAuth:
              CRMSystemuser.SETRANGE(InternalEMailAddress,User."Authentication Email");
          END;
          IF CRMSystemuser.FINDFIRST THEN
            SystemUserId := CRMSystemuser.SystemUserId;
        END;
    END;

    [External]
    PROCEDURE UpdateFromWizard@23(VAR SourceCRMConnectionSetup@1001 : Record 5330;PasswordText@1002 : Text);
    BEGIN
      IF NOT GET THEN BEGIN
        INIT;
        INSERT;
      END;
      VALIDATE("Server Address",SourceCRMConnectionSetup."Server Address");
      VALIDATE("Authentication Type","Authentication Type"::Office365);
      VALIDATE("User Name",SourceCRMConnectionSetup."User Name");
      SetPassword(PasswordText);
      VALIDATE("Proxy Version",SourceCRMConnectionSetup."Proxy Version");
      MODIFY(TRUE);
    END;

    LOCAL PROCEDURE EnableCRMConnection@24();
    BEGIN
      IF "Is Enabled" = xRec."Is Enabled" THEN
        EXIT;

      IF NOT UnregisterConnection THEN
        CLEARLASTERROR;

      IF "Is Enabled" THEN BEGIN
        VerifyTestConnection;
        RegisterUserConnection;
        VerifyBaseCurrencyMatchesLCY;
        EnableIntegrationTables;
        IF "Disable Reason" <> '' THEN
          CRMIntegrationManagement.ClearConnectionDisableReason(Rec);
      END ELSE BEGIN
        "CRM Version" := '';
        "Is S.Order Integration Enabled" := FALSE;
        "Is CRM Solution Installed" := FALSE;
        CurrencyDecimalPrecision := 0;
        CLEAR(BaseCurrencyId);
        BaseCurrencyPrecision := 0;
        BaseCurrencySymbol := '';
        UpdateCRMJobQueueEntriesStatus;
        CRMIntegrationManagement.ClearState;
      END;
    END;

    LOCAL PROCEDURE EnableIntegrationTables@27();
    VAR
      IntegrationTableMapping@1003 : Record 5335;
      IntegrationRecord@1002 : Record 5151;
      IntegrationManagement@1001 : Codeunit 5150;
      CRMSetupDefaults@1000 : Codeunit 5334;
    BEGIN
      IF IntegrationRecord.ISEMPTY THEN
        IntegrationManagement.SetupIntegrationTables;
      IntegrationManagement.SetConnectorIsEnabledForSession(TRUE);
      IF IntegrationTableMapping.ISEMPTY THEN BEGIN
        MODIFY; // Job Queue to read "Is Enabled"
        COMMIT;
        CRMSetupDefaults.ResetConfiguration(Rec);
      END ELSE
        UpdateCRMJobQueueEntriesStatus;
    END;

    [External]
    PROCEDURE EnableCRMConnectionFromWizard@25();
    VAR
      CRMSystemuser@1001 : Record 5340;
    BEGIN
      GET;
      "Is User Mapping Required" := FALSE;
      VALIDATE("Is Enabled",TRUE);
      MODIFY(TRUE);

      FilterCRMSystemUser(CRMSystemuser);
      CRMSystemuser.FINDFIRST;
      IF (CRMSystemuser.InviteStatusCode <> CRMSystemuser.InviteStatusCode::InvitationAccepted) OR
         (NOT CRMSystemuser.IsIntegrationUser)
      THEN BEGIN
        CRMSystemuser.InviteStatusCode := CRMSystemuser.InviteStatusCode::InvitationAccepted;
        CRMSystemuser.IsIntegrationUser := TRUE;
        CRMSystemuser.MODIFY(TRUE);
      END;
    END;

    PROCEDURE RestoreConnection@59();
    BEGIN
      // This function should be called from OnAfterUpgradeComplete trigger (when introduced)
      IF "Restore Connection" THEN BEGIN
        "Restore Connection" := FALSE;
        MODIFY;
        COMMIT;
        IF TestConnection THEN
          VALIDATE("Is Enabled",TRUE);
        MODIFY;
      END;
    END;

    [External]
    PROCEDURE SetCRMSOPEnabled@37();
    BEGIN
      TESTFIELD("Is CRM Solution Installed",TRUE);
      SetCRMSOPEnabledWithCredentials('',CREATEGUID,TRUE);
    END;

    PROCEDURE SetCRMSOPDisabled@55();
    VAR
      CRMSalesorder@1000 : Record 5353;
    BEGIN
      CRMSalesorder.SETRANGE(StateCode,CRMSalesorder.StateCode::Submitted);
      IF NOT CRMSalesorder.ISEMPTY THEN
        ERROR(CannotDisableSalesOrderIntErr);
      SetCRMSOPEnabledWithCredentials('',CREATEGUID,FALSE);
      VALIDATE("Auto Create Sales Orders",FALSE);
    END;

    [External]
    PROCEDURE SetCRMSOPEnabledWithCredentials@36(AdminEmail@1003 : Text[250];AdminPassKey@1004 : GUID;SOPIntegrationEnable@1006 : Boolean);
    VAR
      CRMOrganization@1000 : Record 5363;
      TempCRMConnectionSetup@1001 : TEMPORARY Record 5330;
      ServicePassword@1005 : Record 1261;
      ConnectionName@1002 : Text;
    BEGIN
      CreateTempAdminConnection(TempCRMConnectionSetup);
      IF (AdminEmail <> '') AND (NOT ISNULLGUID(AdminPassKey)) THEN BEGIN
        ServicePassword.GET(AdminPassKey);
        TempCRMConnectionSetup.SetPassword(ServicePassword.GetPassword);
        TempCRMConnectionSetup.VALIDATE("User Name",AdminEmail);
      END;
      ConnectionName := FORMAT(CREATEGUID);
      TempCRMConnectionSetup.RegisterConnectionWithName(ConnectionName);
      SETDEFAULTTABLECONNECTION(
        TABLECONNECTIONTYPE::CRM,GetDefaultCRMConnection(ConnectionName),TRUE);

      CRMOrganization.FINDFIRST;
      IF CRMOrganization.IsSOPIntegrationEnabled <> SOPIntegrationEnable THEN BEGIN
        CRMOrganization.IsSOPIntegrationEnabled := SOPIntegrationEnable;
        CRMOrganization.MODIFY(TRUE);
      END;

      TempCRMConnectionSetup.UnregisterConnectionWithName(ConnectionName);
    END;

    [External]
    PROCEDURE SetUserAsIntegrationUser@39();
    VAR
      CRMSystemuser@1000 : Record 5340;
      TempCRMConnectionSetup@1001 : TEMPORARY Record 5330;
      ConnectionName@1002 : Text;
    BEGIN
      CreateTempAdminConnection(TempCRMConnectionSetup);
      ConnectionName := FORMAT(CREATEGUID);
      TempCRMConnectionSetup.RegisterConnectionWithName(ConnectionName);
      SETDEFAULTTABLECONNECTION(
        TABLECONNECTIONTYPE::CRM,GetDefaultCRMConnection(ConnectionName),TRUE);
      FilterCRMSystemUser(CRMSystemuser);
      CRMSystemuser.FINDFIRST;

      IF (CRMSystemuser.InviteStatusCode <> CRMSystemuser.InviteStatusCode::InvitationAccepted) OR
         (NOT CRMSystemuser.IsIntegrationUser)
      THEN BEGIN
        CRMSystemuser.InviteStatusCode := CRMSystemuser.InviteStatusCode::InvitationAccepted;
        CRMSystemuser.IsIntegrationUser := TRUE;
        CRMSystemuser.MODIFY(TRUE);
      END;

      TempCRMConnectionSetup.UnregisterConnectionWithName(ConnectionName);
    END;

    LOCAL PROCEDURE CreateTempAdminConnection@40(VAR CRMConnectionSetup@1000 : Record 5330);
    BEGIN
      CreateTempNoDelegateConnection(CRMConnectionSetup);
      CLEAR(CRMConnectionSetup."User Password Key");
      CRMConnectionSetup.VALIDATE("User Name",'');
    END;

    LOCAL PROCEDURE CreateTempNoDelegateConnection@41(VAR CRMConnectionSetup@1000 : Record 5330);
    BEGIN
      CRMConnectionSetup.INIT;
      CALCFIELDS("Server Connection String");
      CRMConnectionSetup.TRANSFERFIELDS(Rec);
      CRMConnectionSetup."Primary Key" := COPYSTR('TEMP' + "Primary Key",1,MAXSTRLEN(CRMConnectionSetup."Primary Key"));
      CRMConnectionSetup."Is Enabled" := TRUE;
      CRMConnectionSetup."Is User Mapping Required" := FALSE;
    END;

    PROCEDURE RefreshDataFromCRM@31();
    VAR
      TempCRMConnectionSetup@1000 : TEMPORARY Record 5330;
      ConnectionName@1001 : Text;
    BEGIN
      IF "Is Enabled" THEN BEGIN
        IF "Is User Mapping Required" THEN BEGIN
          CreateTempNoDelegateConnection(TempCRMConnectionSetup);
          ConnectionName := FORMAT(CREATEGUID);
          TempCRMConnectionSetup.RegisterConnectionWithName(ConnectionName);
          "Is User Mapped To CRM User" := IsCurrentUserMappedToCrmSystemUser;
        END;

        "Is CRM Solution Installed" := CRMIntegrationManagement.IsCRMSolutionInstalled;
        RefreshFromCRMConnectionInformation;
        IF TryRefreshCRMSettings THEN;

        IF ConnectionName <> '' THEN
          TempCRMConnectionSetup.UnregisterConnectionWithName(ConnectionName);
      END;
    END;

    LOCAL PROCEDURE RefreshFromCRMConnectionInformation@29();
    VAR
      CRMNAVConnection@1001 : Record 5368;
    BEGIN
      IF "Is CRM Solution Installed" THEN
        IF CRMNAVConnection.FINDFIRST THEN BEGIN
          "Dynamics NAV URL" := CRMNAVConnection."Dynamics NAV URL";
          "Dynamics NAV OData URL" := CRMNAVConnection."Dynamics NAV OData URL";
          "Dynamics NAV OData Username" := CRMNAVConnection."Dynamics NAV OData Username";
          "Dynamics NAV OData Accesskey" := CRMNAVConnection."Dynamics NAV OData Accesskey";
        END;
    END;

    [TryFunction]
    LOCAL PROCEDURE TryRefreshCRMSettings@26();
    VAR
      CRMOrganization@1001 : Record 5363;
    BEGIN
      GetCrmVersion("CRM Version");
      VALIDATE("CRM Version");

      IF CRMOrganization.FINDFIRST THEN BEGIN
        "Is S.Order Integration Enabled" := CRMOrganization.IsSOPIntegrationEnabled;
        CurrencyDecimalPrecision := CRMOrganization.CurrencyDecimalPrecision;
        BaseCurrencyId := CRMOrganization.BaseCurrencyId;
        BaseCurrencyPrecision := CRMOrganization.BaseCurrencyPrecision;
        BaseCurrencySymbol := CRMOrganization.BaseCurrencySymbol;
      END ELSE
        "Is S.Order Integration Enabled" := FALSE;
    END;

    LOCAL PROCEDURE VerifyBaseCurrencyMatchesLCY@35();
    VAR
      CRMOrganization@1001 : Record 5363;
      CRMTransactioncurrency@1002 : Record 5345;
      GLSetup@1000 : Record 98;
    BEGIN
      CRMOrganization.FINDFIRST;
      CRMTransactioncurrency.GET(CRMOrganization.BaseCurrencyId);
      GLSetup.GET;
      IF DELCHR(CRMTransactioncurrency.ISOCurrencyCode) <> DELCHR(GLSetup."LCY Code") THEN
        ERROR(LCYMustMatchBaseCurrencyErr,GLSetup."LCY Code",CRMTransactioncurrency.ISOCurrencyCode);
    END;

    PROCEDURE PerformWebClientUrlReset@32();
    VAR
      TempCRMConnectionSetup@1000 : TEMPORARY Record 5330;
      CRMSetupDefaults@1002 : Codeunit 5334;
      ConnectionName@1001 : Text;
    BEGIN
      CreateTempNoDelegateConnection(TempCRMConnectionSetup);
      ConnectionName := FORMAT(CREATEGUID);
      TempCRMConnectionSetup.RegisterConnectionWithName(ConnectionName);
      SETDEFAULTTABLECONNECTION(
        TABLECONNECTIONTYPE::CRM,GetDefaultCRMConnection(ConnectionName),TRUE);

      CRMSetupDefaults.ResetCRMNAVConnectionData;

      TempCRMConnectionSetup.UnregisterConnectionWithName(ConnectionName);

      RefreshDataFromCRM;
    END;

    [External]
    PROCEDURE SynchronizeNow@44(DoFullSynch@1000 : Boolean);
    VAR
      IntegrationTableMapping@1006 : Record 5335;
      TempNameValueBuffer@1005 : TEMPORARY Record 823;
      CRMSetupDefaults@1004 : Codeunit 5334;
      ProgressWindow@1003 : Dialog;
      MappingCount@1002 : Integer;
      CurrentMappingIndex@1001 : Integer;
    BEGIN
      CRMSetupDefaults.GetPrioritizedMappingList(TempNameValueBuffer);
      TempNameValueBuffer.ASCENDING(TRUE);
      TempNameValueBuffer.FINDSET;

      CurrentMappingIndex := 0;
      MappingCount := TempNameValueBuffer.COUNT;
      ProgressWindow.OPEN(ProcessDialogMapTitleMsg,CurrentMappingIndex);
      REPEAT
        CurrentMappingIndex := CurrentMappingIndex + 1;
        ProgressWindow.UPDATE(1,ROUND(CurrentMappingIndex / MappingCount * 10000,1));
        IF IntegrationTableMapping.GET(TempNameValueBuffer.Value) THEN
          IntegrationTableMapping.SynchronizeNow(DoFullSynch);
      UNTIL TempNameValueBuffer.NEXT = 0;
      ProgressWindow.CLOSE;
    END;

    LOCAL PROCEDURE ShowError@336(ActivityDescription@1001 : Text[128];ErrorMessage@1000 : Text);
    VAR
      MyNotifications@1003 : Record 1518;
      LogonManagement@1002 : Codeunit 9802;
    BEGIN
      IF NOT LogonManagement.IsLogonInProgress THEN
        ERROR(ErrorMessage);

      MyNotifications.InsertDefault(GetCRMNotificationId,ActivityDescription,ErrorMessage,TRUE);
    END;

    LOCAL PROCEDURE GetCRMNotificationId@28() : GUID;
    BEGIN
      EXIT('692A2701-4BBB-4C5B-B4C0-629D96B60644');
    END;

    PROCEDURE DoReadCRMData@45() : Boolean;
    VAR
      SkipReading@1000 : Boolean;
    BEGIN
      OnReadingCRMData(SkipReading);
      EXIT(NOT SkipReading);
    END;

    [Integration]
    LOCAL PROCEDURE OnReadingCRMData@22(VAR SkipReading@1000 : Boolean);
    BEGIN
    END;

    PROCEDURE GetDefaultCRMConnection@46(ConnectionName@1000 : Text) : Text;
    BEGIN
      OnGetDefaultCRMConnection(ConnectionName);
      EXIT(ConnectionName);
    END;

    [Integration]
    LOCAL PROCEDURE OnGetDefaultCRMConnection@48(VAR ConnectionName@1000 : Text);
    BEGIN
    END;

    LOCAL PROCEDURE CrmAuthenticationType@49() : Text;
    BEGIN
      CASE "Authentication Type" OF
        "Authentication Type"::Office365:
          EXIT('AuthType=Office365;');
        "Authentication Type"::AD:
          EXIT('AuthType=AD;' + GetDomain);
        "Authentication Type"::IFD:
          EXIT('AuthType=IFD;' + GetDomain + 'HomeRealmUri= ;');
        "Authentication Type"::OAuth:
          EXIT('AuthType=OAuth;' + 'AppId= ;' + 'RedirectUri= ;' + 'TokenCacheStorePath= ;' + 'LoginPrompt=Auto;');
      END;
    END;

    PROCEDURE UpdateConnectionString@50() ConnectionString : Text;
    BEGIN
      ConnectionString :=
        STRSUBSTNO(
          ConnectionStringFormatTok,"Server Address",GetUserName,MissingPasswordTok,"Proxy Version",CrmAuthenticationType);
      SetConnectionString(ConnectionString);
    END;

    LOCAL PROCEDURE UpdateDomainName@54();
    BEGIN
      IF "User Name" <> '' THEN
        IF STRPOS("User Name",'\') > 0 THEN
          VALIDATE(Domain,COPYSTR("User Name",1,STRPOS("User Name",'\') - 1))
        ELSE
          Domain := '';
    END;

    LOCAL PROCEDURE CheckUserName@47();
    BEGIN
      IF "User Name" <> '' THEN
        CASE "Authentication Type" OF
          "Authentication Type"::AD:
            IF STRPOS("User Name",'\') = 0 THEN
              ERROR(UserNameMustIncludeDomainErr);
          "Authentication Type"::Office365:
            IF STRPOS("User Name",'@') = 0 THEN
              ERROR(UserNameMustBeEmailErr);
        END;
    END;

    LOCAL PROCEDURE GetDomain@68() : Text;
    BEGIN
      IF Domain <> '' THEN
        EXIT(STRSUBSTNO('Domain=%1;',Domain));
    END;

    LOCAL PROCEDURE FilterCRMSystemUser@57(VAR CRMSystemuser@1000 : Record 5340);
    BEGIN
      CASE "Authentication Type" OF
        "Authentication Type"::Office365,"Authentication Type"::OAuth:
          CRMSystemuser.SETRANGE(InternalEMailAddress,"User Name");
        "Authentication Type"::AD,"Authentication Type"::IFD:
          CRMSystemuser.SETRANGE(DomainName,"User Name");
      END;
    END;

    PROCEDURE UpdateCRMJobQueueEntriesStatus@52();
    VAR
      IntegrationTableMapping@1000 : Record 5335;
      JobQueueEntry@1001 : Record 472;
      NewStatus@1002 : Option;
    BEGIN
      IF "Is Enabled" THEN
        NewStatus := JobQueueEntry.Status::Ready
      ELSE
        NewStatus := JobQueueEntry.Status::"On Hold";
      IntegrationTableMapping.SETRANGE("Synch. Codeunit ID",CODEUNIT::"CRM Integration Table Synch.");
      IntegrationTableMapping.SETRANGE("Delete After Synchronization",FALSE);
      IF IntegrationTableMapping.FINDSET THEN
        REPEAT
          JobQueueEntry.SETRANGE("Record ID to Process",IntegrationTableMapping.RECORDID);
          IF JobQueueEntry.FINDSET THEN
            REPEAT
              JobQueueEntry.SetStatus(NewStatus);
            UNTIL JobQueueEntry.NEXT = 0;
        UNTIL IntegrationTableMapping.NEXT = 0;
    END;

    PROCEDURE UpdateLastUpdateInvoiceEntryNo@38() : Boolean;
    VAR
      DtldCustLedgEntry@1000 : Record 379;
    BEGIN
      GET;
      DtldCustLedgEntry.RESET;
      IF DtldCustLedgEntry.FINDLAST THEN
        IF "Last Update Invoice Entry No." <> DtldCustLedgEntry."Entry No." THEN BEGIN
          "Last Update Invoice Entry No." := DtldCustLedgEntry."Entry No.";
          EXIT(MODIFY);
        END;
    END;

    PROCEDURE GetConnectionString@3() ConnectionString : Text;
    VAR
      CRMConnectionSetup@1001 : Record 5330;
      InStream@1000 : InStream;
    BEGIN
      IF CRMConnectionSetup.GET("Primary Key") THEN
        CALCFIELDS("Server Connection String");
      "Server Connection String".CREATEINSTREAM(InStream);
      InStream.READTEXT(ConnectionString);
    END;

    PROCEDURE SetConnectionString@56(ConnectionString@1000 : Text);
    VAR
      OutStream@1001 : OutStream;
    BEGIN
      IF ConnectionString = '' THEN
        CLEAR("Server Connection String")
      ELSE BEGIN
        IF STRPOS(ConnectionString,MissingPasswordTok) = 0 THEN
          ERROR(ConnectionStringPwdPlaceHolderMissingErr);
        CLEAR("Server Connection String");
        "Server Connection String".CREATEOUTSTREAM(OutStream);
        OutStream.WRITETEXT(ConnectionString);
      END;
      IF NOT MODIFY THEN ;
    END;

    BEGIN
    END.
  }
}

