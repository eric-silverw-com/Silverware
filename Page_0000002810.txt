OBJECT Page 2810 Native - Sales Inv. Entity
{
  OBJECT-PROPERTIES
  {
    Date=09/19/18;
    Time=12:00:00 PM;
    Version List=NAVW113.00;
  }
  PROPERTIES
  {
    CaptionML=[@@@={Locked};
               ENU=nativeInvoicingSalesInvoices;
               ESM=nativeInvoicingSalesInvoices;
               FRC=nativeInvoicingSalesInvoices;
               ENC=nativeInvoicingSalesInvoices];
    SourceTable=Table5475;
    DelayedInsert=Yes;
    PageType=List;
    OnOpenPage=BEGIN
                 BINDSUBSCRIPTION(NativeAPILanguageHandler);
                 SELECTLATESTVERSION;
               END;

    OnAfterGetRecord=VAR
                       SalesHeader@1000 : Record 36;
                       SalesInvoiceHeader@1002 : Record 112;
                       SalesInvoiceAggregator@1001 : Codeunit 5477;
                       GraphMgtGeneralTools@1003 : Codeunit 5465;
                     BEGIN
                       IF NOT GetParentRecordNativeInvoicing(SalesHeader,SalesInvoiceHeader) THEN BEGIN
                         GraphMgtGeneralTools.CleanAggregateWithoutParent(Rec);
                         EXIT;
                       END;

                       SetCalculatedFields(SalesHeader,SalesInvoiceHeader);
                       SalesInvoiceAggregator.RedistributeInvoiceDiscounts(Rec);
                     END;

    OnNewRecord=BEGIN
                  ClearCalculatedFields;
                END;

    OnInsertRecord=VAR
                     SalesHeader@1003 : Record 36;
                     SalesInvoiceHeader@1001 : Record 112;
                     SalesInvoiceAggregator@1002 : Codeunit 5477;
                   BEGIN
                     CheckCustomer;
                     ProcessBillingPostalAddress;

                     SalesInvoiceAggregator.PropagateOnInsert(Rec,TempFieldBuffer);
                     SetDates;

                     UpdateAttachments;
                     UpdateLines;
                     UpdateDiscount;
                     UpdateCoupons;
                     SetNoteForCustomer;

                     IF NOT GetParentRecordNativeInvoicing(SalesHeader,SalesInvoiceHeader) THEN
                       ERROR(AggregateParentIsMissingErr);

                     SetCalculatedFields(SalesHeader,SalesInvoiceHeader);

                     EXIT(FALSE);
                   END;

    OnModifyRecord=VAR
                     SalesHeader@1001 : Record 36;
                     SalesInvoiceHeader@1000 : Record 112;
                     SalesInvoiceAggregator@1002 : Codeunit 5477;
                   BEGIN
                     IF Posted THEN BEGIN
                       IF NOT IsAttachmentsSet THEN
                         EXIT(FALSE);
                       UpdateAttachments;
                       SetAttachmentsJSON;
                       EXIT(FALSE);
                     END;

                     IF xRec.Id <> Id THEN
                       ERROR(CannotChangeIDErr);

                     ProcessBillingPostalAddress;

                     SalesInvoiceAggregator.PropagateOnModify(Rec,TempFieldBuffer);

                     UpdateAttachments;
                     UpdateLines;
                     UpdateDiscount;
                     UpdateCoupons;
                     SetNoteForCustomer;

                     IF NOT GetParentRecordNativeInvoicing(SalesHeader,SalesInvoiceHeader) THEN
                       ERROR(AggregateParentIsMissingErr);

                     SetCalculatedFields(SalesHeader,SalesInvoiceHeader);

                     EXIT(FALSE);
                   END;

    OnDeleteRecord=VAR
                     SalesInvoiceAggregator@1000 : Codeunit 5477;
                   BEGIN
                     SalesInvoiceAggregator.PropagateOnDelete(Rec);

                     EXIT(FALSE);
                   END;

    ODataKeyFields=Id;
  }
  CONTROLS
  {
    { 21  ;0   ;Container ;
                ContainerType=ContentArea }

    { 20  ;1   ;Group     ;
                Name=Group;
                GroupType=Repeater }

    { 19  ;2   ;Field     ;
                Name=id;
                CaptionML=[@@@={Locked};
                           ENU=id;
                           ESM=id;
                           FRC=id;
                           ENC=id];
                ApplicationArea=#All;
                SourceExpr=Id;
                OnValidate=BEGIN
                             CheckStatus;
                             RegisterFieldSet(FIELDNO(Id));
                           END;
                            }

    { 18  ;2   ;Field     ;
                Name=number;
                CaptionML=[@@@={Locked};
                           ENU=Number;
                           ESM=Number;
                           FRC=Number;
                           ENC=Number];
                ApplicationArea=#All;
                SourceExpr="No.";
                Editable=FALSE }

    { 14  ;2   ;Field     ;
                Name=customerId;
                CaptionML=[@@@={Locked};
                           ENU=customerId;
                           ESM=customerId;
                           FRC=customerId;
                           ENC=customerId];
                ApplicationArea=#All;
                SourceExpr="Customer Id";
                OnValidate=VAR
                             O365SalesInvoiceMgmt@1000 : Codeunit 2310;
                           BEGIN
                             CheckStatus;

                             Customer.SETRANGE(Id,"Customer Id");

                             IF NOT Customer.FINDFIRST THEN
                               ERROR(CannotFindCustomerErr);

                             O365SalesInvoiceMgmt.EnforceCustomerTemplateIntegrity(Customer);

                             "Sell-to Customer No." := Customer."No.";
                             RegisterFieldSet(FIELDNO("Customer Id"));
                             RegisterFieldSet(FIELDNO("Sell-to Customer No."));
                             CustomerIdSet := TRUE;
                           END;
                            }

    { 23  ;2   ;Field     ;
                Name=graphContactId;
                CaptionML=[@@@={Locked};
                           ENU=graphContactId;
                           ESM=graphContactId;
                           FRC=graphContactId;
                           ENC=graphContactId];
                ApplicationArea=#All;
                SourceExpr="Contact Graph Id";
                OnValidate=VAR
                             Contact@1000 : Record 5050;
                             Customer@1001 : Record 18;
                             GraphIntContact@1003 : Codeunit 5461;
                           BEGIN
                             CheckStatus;

                             IF ("Contact Graph Id" = '') AND CustomerIdSet THEN
                               EXIT;

                             RegisterFieldSet(FIELDNO("Contact Graph Id"));

                             IF "Contact Graph Id" = '' THEN
                               ERROR(ContactIdHasToHaveValueErr);

                             IF NOT GraphIntContact.FindOrCreateCustomerFromGraphContactSafe("Contact Graph Id",Customer,Contact) THEN
                               EXIT;

                             UpdateCustomerFromGraphContactId(Customer);

                             IF Contact."Company No." = Customer."No." THEN BEGIN
                               VALIDATE("Sell-to Contact No.",Contact."No.");
                               VALIDATE("Sell-to Contact",Contact.Name);

                               RegisterFieldSet(FIELDNO("Sell-to Contact No."));
                               RegisterFieldSet(FIELDNO("Sell-to Contact"));
                             END;
                           END;
                            }

    { 36  ;2   ;Field     ;
                Name=customerNumber;
                CaptionML=[@@@={Locked};
                           ENU=customerNumber;
                           ESM=customerNumber;
                           FRC=customerNumber;
                           ENC=customerNumber];
                ApplicationArea=#All;
                SourceExpr="Sell-to Customer No.";
                OnValidate=VAR
                             O365SalesInvoiceMgmt@1000 : Codeunit 2310;
                           BEGIN
                             CheckStatus;

                             IF Customer."No." <> '' THEN
                               EXIT;

                             IF NOT Customer.GET("Sell-to Customer No.") THEN
                               ERROR(CannotFindCustomerErr);

                             O365SalesInvoiceMgmt.EnforceCustomerTemplateIntegrity(Customer);

                             "Customer Id" := Customer.Id;
                             RegisterFieldSet(FIELDNO("Customer Id"));
                             RegisterFieldSet(FIELDNO("Sell-to Customer No."));
                           END;
                            }

    { 3   ;2   ;Field     ;
                Name=taxLiable;
                CaptionML=[ENU=taxLiable;
                           ESM=taxLiable;
                           FRC=taxLiable;
                           ENC=taxLiable];
                ToolTipML=[ENU=Specifies if the sales invoice contains sales tax.;
                           ESM=Especifica si la factura de venta incluye el impuesto sobre las ventas.;
                           FRC=Indique si la facture vente contient la taxe de vente.;
                           ENC=Specifies if the sales invoice contains sales tax.];
                ApplicationArea=#All;
                SourceExpr="Tax Liable";
                Importance=Additional;
                OnValidate=BEGIN
                             CheckStatus;
                             RegisterFieldSet(FIELDNO("Tax Liable"));
                           END;
                            }

    { 26  ;2   ;Field     ;
                Name=taxAreaId;
                CaptionML=[ENU=taxAreaId;
                           ESM=taxAreaId;
                           FRC=taxAreaId;
                           ENC=taxAreaId];
                ApplicationArea=#All;
                SourceExpr="Tax Area ID";
                OnValidate=BEGIN
                             CheckStatus;

                             RegisterFieldSet(FIELDNO("Tax Area ID"));

                             IF IsUsingVAT THEN
                               RegisterFieldSet(FIELDNO("VAT Bus. Posting Group"))
                             ELSE
                               RegisterFieldSet(FIELDNO("Tax Area Code"));
                           END;
                            }

    { 33  ;2   ;Field     ;
                Name=taxAreaDisplayName;
                CaptionML=[ENU=taxAreaDisplayName;
                           ESM=taxAreaDisplayName;
                           FRC=taxAreaDisplayName;
                           ENC=taxAreaDisplayName];
                ToolTipML=[ENU=Specifies the tax area display name.;
                           ESM=Especifica el nombre para mostrar en el  rea de impuestos.;
                           FRC=Sp‚cifie le nom d'affichage de la r‚gion fiscale.;
                           ENC=Specifies the tax area display name.];
                ApplicationArea=#All;
                SourceExpr=TaxAreaDisplayName;
                Editable=FALSE }

    { 5   ;2   ;Field     ;
                Name=taxRegistrationNumber;
                CaptionML=[ENU=taxRegistrationNumber;
                           ESM=taxRegistrationNumber;
                           FRC=taxRegistrationNumber;
                           ENC=taxRegistrationNumber];
                ApplicationArea=#All;
                SourceExpr="VAT Registration No.";
                OnValidate=BEGIN
                             CheckStatus;
                             RegisterFieldSet(FIELDNO("VAT Registration No."));
                           END;
                            }

    { 15  ;2   ;Field     ;
                Name=customerName;
                CaptionML=[@@@={Locked};
                           ENU=customerName;
                           ESM=customerName;
                           FRC=customerName;
                           ENC=customerName];
                ApplicationArea=#All;
                SourceExpr="Sell-to Customer Name";
                Editable=FALSE }

    { 27  ;2   ;Field     ;
                Name=customerEmail;
                CaptionML=[@@@={Locked};
                           ENU=customerEmail;
                           ESM=customerEmail;
                           FRC=customerEmail;
                           ENC=customerEmail];
                ToolTipML=[ENU=Specifies the email address of the customer.;
                           ESM=Especifica la direcci¢n de correo electr¢nico del cliente.;
                           FRC=Sp‚cifie l'adresse ‚lectronique du client.;
                           ENC=Specifies the email address of the customer.];
                ApplicationArea=#All;
                SourceExpr=CustomerEmail;
                Editable=FALSE }

    { 22  ;2   ;Field     ;
                Name=invoiceDate;
                CaptionML=[@@@={Locked};
                           ENU=invoiceDate;
                           ESM=invoiceDate;
                           FRC=invoiceDate;
                           ENC=invoiceDate];
                ApplicationArea=#All;
                SourceExpr="Document Date";
                OnValidate=BEGIN
                             CheckStatus;

                             DocumentDateVar := "Document Date";
                             DocumentDateSet := TRUE;

                             RegisterFieldSet(FIELDNO("Document Date"));
                             RegisterFieldSet(FIELDNO("Posting Date"));
                           END;
                            }

    { 24  ;2   ;Field     ;
                Name=dueDate;
                CaptionML=[@@@={Locked};
                           ENU=dueDate;
                           ESM=dueDate;
                           FRC=dueDate;
                           ENC=dueDate];
                ApplicationArea=#All;
                SourceExpr="Due Date";
                OnValidate=BEGIN
                             CheckStatus;

                             DueDateVar := "Due Date";
                             DueDateSet := TRUE;

                             RegisterFieldSet(FIELDNO("Due Date"));
                           END;
                            }

    { 6   ;2   ;Field     ;
                Name=billingPostalAddress;
                CaptionML=[@@@={Locked};
                           ENU=billingPostalAddress;
                           ESM=billingPostalAddress;
                           FRC=billingPostalAddress;
                           ENC=billingPostalAddress];
                ToolTipML=[ENU=Specifies the billing address of the Sales Invoice.;
                           ESM=Especifica la direcci¢n de facturaci¢n de la factura de venta.;
                           FRC=Sp‚cifie l'adresse de facturation de la facture vente.;
                           ENC=Specifies the billing address of the Sales Invoice.];
                ApplicationArea=#All;
                SourceExpr=BillingPostalAddressJSONText;
                OnValidate=BEGIN
                             CheckStatus;
                             BillingPostalAddressSet := TRUE;
                           END;

                ODataEDMType=POSTALADDRESS }

    { 28  ;2   ;Field     ;
                Name=pricesIncludeTax;
                CaptionML=[@@@={Locked};
                           ENU=pricesIncludeTax;
                           ESM=pricesIncludeTax;
                           FRC=pricesIncludeTax;
                           ENC=pricesIncludeTax];
                ApplicationArea=#All;
                SourceExpr="Prices Including VAT";
                Editable=FALSE }

    { 38  ;2   ;Field     ;
                Name=currencyCode;
                CaptionML=[@@@={Locked};
                           ENU=currencyCode;
                           ESM=currencyCode;
                           FRC=currencyCode;
                           ENC=currencyCode];
                ToolTipML=[ENU=Specifies the currency code.;
                           ESM=Especifica el c¢digo de divisa.;
                           FRC=Sp‚cifie le code devise.;
                           ENC=Specifies the currency code.];
                ApplicationArea=#All;
                SourceExpr=CurrencyCodeTxt;
                Editable=FALSE }

    { 1   ;2   ;Field     ;
                Name=lines;
                CaptionML=[@@@={Locked};
                           ENU=lines;
                           ESM=lines;
                           FRC=lines;
                           ENC=lines];
                ToolTipML=[ENU=Specifies Sales Invoice Lines;
                           ESM=Especifica las l¡neas de factura de venta.;
                           FRC=Sp‚cifie les lignes facture vente;
                           ENC=Specifies Sales Invoice Lines];
                ApplicationArea=#All;
                SourceExpr=SalesInvoiceLinesJSON;
                OnValidate=BEGIN
                             CheckStatus;
                             SalesLinesSet := PreviousSalesInvoiceLinesJSON <> SalesInvoiceLinesJSON;
                           END;

                ODataEDMType=Collection(NATIVE-SALESINVOICE-LINE) }

    { 17  ;2   ;Field     ;
                Name=subtotalAmount;
                CaptionML=[ENU=subtotalAmount;
                           ESM=subtotalAmount;
                           FRC=subtotalAmount;
                           ENC=subtotalAmount];
                ApplicationArea=#All;
                SourceExpr="Subtotal Amount";
                Editable=FALSE }

    { 11  ;2   ;Field     ;
                Name=discountAmount;
                CaptionML=[@@@={Locked};
                           ENU=discountAmount;
                           ESM=discountAmount;
                           FRC=discountAmount;
                           ENC=discountAmount];
                ApplicationArea=#All;
                SourceExpr="Invoice Discount Amount";
                Editable=FALSE }

    { 10  ;2   ;Field     ;
                Name=discountAppliedBeforeTax;
                CaptionML=[@@@={Locked};
                           ENU=discountAppliedBeforeTax;
                           ESM=discountAppliedBeforeTax;
                           FRC=discountAppliedBeforeTax;
                           ENC=discountAppliedBeforeTax];
                ApplicationArea=#All;
                SourceExpr="Discount Applied Before Tax";
                Editable=FALSE }

    { 25  ;2   ;Field     ;
                Name=coupons;
                CaptionML=[@@@={Locked};
                           ENU=coupons;
                           ESM=coupons;
                           FRC=coupons;
                           ENC=coupons];
                ToolTipML=[ENU=Specifies Sales Invoice Coupons.;
                           ESM=Especifica los cupones de factura de venta.;
                           FRC=Sp‚cifie les coupons facture vente.;
                           ENC=Specifies Sales Invoice Coupons.];
                ApplicationArea=#All;
                SourceExpr=CouponsJSON;
                OnValidate=BEGIN
                             CheckStatus;
                             CouponsSet := PreviousCouponsJSON <> CouponsJSON;
                           END;

                ODataEDMType=Collection(NATIVE-SALESDOCUMENT-COUPON) }

    { 9   ;2   ;Field     ;
                Name=totalAmountExcludingTax;
                CaptionML=[@@@={Locked};
                           ENU=totalAmountExcludingTax;
                           ESM=totalAmountExcludingTax;
                           FRC=totalAmountExcludingTax;
                           ENC=totalAmountExcludingTax];
                ApplicationArea=#All;
                SourceExpr=Amount;
                Editable=FALSE }

    { 8   ;2   ;Field     ;
                Name=totalTaxAmount;
                CaptionML=[@@@={Locked};
                           ENU=totalTaxAmount;
                           ESM=totalTaxAmount;
                           FRC=totalTaxAmount;
                           ENC=totalTaxAmount];
                ToolTipML=[ENU=Specifies the total tax amount for the sales invoice.;
                           ESM=Especifica el importe de impuesto total de la factura de venta.;
                           FRC=Sp‚cifie le montant total de taxe de la facture vente.;
                           ENC=Specifies the total tax amount for the sales invoice.];
                ApplicationArea=#All;
                SourceExpr="Total Tax Amount";
                Editable=FALSE }

    { 7   ;2   ;Field     ;
                Name=totalAmountIncludingTax;
                CaptionML=[@@@={Locked};
                           ENU=totalAmountIncludingTax;
                           ESM=totalAmountIncludingTax;
                           FRC=totalAmountIncludingTax;
                           ENC=totalAmountIncludingTax];
                ApplicationArea=#All;
                SourceExpr="Amount Including VAT";
                Editable=FALSE }

    { 16  ;2   ;Field     ;
                Name=noteForCustomer;
                CaptionML=[ENU=noteForCustomer;
                           ESM=noteForCustomer;
                           FRC=noteForCustomer;
                           ENC=noteForCustomer];
                ToolTipML=[ENU=Specifies the note for the customer.;
                           ESM=Especifica la nota para el cliente.;
                           FRC=Sp‚cifie la note pour le client.;
                           ENC=Specifies the note for the customer.];
                ApplicationArea=#All;
                SourceExpr=WorkDescription;
                OnValidate=BEGIN
                             CheckStatus;
                             NoteForCustomerSet := TRUE;
                           END;
                            }

    { 13  ;2   ;Field     ;
                Name=status;
                CaptionML=[@@@={Locked};
                           ENU=status;
                           ESM=status;
                           FRC=status;
                           ENC=status];
                ToolTipML=[ENU=Specifies the status of the Sales Invoice (canceled, paid, on hold, created).;
                           ESM=Especifica el estado de la factura de ventas (cancelada, pagada, en espera, creada).;
                           FRC=Sp‚cifie l'‚tat de la facture vente (annul‚e, pay‚e, en attente, cr‚‚e).;
                           ENC=Specifies the status of the Sales Invoice (cancelled, paid, on hold, created).];
                ApplicationArea=#All;
                SourceExpr=Status;
                Editable=FALSE }

    { 2   ;2   ;Field     ;
                Name=lastModifiedDateTime;
                CaptionML=[@@@={Locked};
                           ENU=lastModifiedDateTime;
                           ESM=lastModifiedDateTime;
                           FRC=lastModifiedDateTime;
                           ENC=lastModifiedDateTime];
                ApplicationArea=#All;
                SourceExpr="Last Modified Date Time";
                Editable=FALSE }

    { 30  ;2   ;Field     ;
                Name=attachments;
                CaptionML=[@@@={Locked};
                           ENU=attachments;
                           ESM=attachments;
                           FRC=attachments;
                           ENC=attachments];
                ToolTipML=[ENU=Specifies Attachments;
                           ESM=Especifica los datos adjuntos;
                           FRC=Sp‚cifie les piŠces jointes;
                           ENC=Specifies Attachments];
                ApplicationArea=#All;
                SourceExpr=AttachmentsJSON;
                OnValidate=BEGIN
                             IsAttachmentsSet := AttachmentsJSON <> PreviousAttachmentsJSON;
                           END;

                ODataEDMType=Collection(NATIVE-ATTACHMENT) }

    { 4   ;2   ;Field     ;
                Name=invoiceDiscountCalculation;
                CaptionML=[ENU=invoiceDiscountCalculation;
                           ESM=invoiceDiscountCalculation;
                           FRC=invoiceDiscountCalculation;
                           ENC=invoiceDiscountCalculation];
                OptionCaptionML=[@@@={Locked};
                                 ENU=,%,Amount;
                                 ESM=,%,Amount;
                                 FRC=,%,Amount;
                                 ENC=,%,Amount];
                ApplicationArea=#All;
                SourceExpr="Invoice Discount Calculation";
                OnValidate=BEGIN
                             CheckStatus;
                             RegisterFieldSet(FIELDNO("Invoice Discount Calculation"));
                             DiscountAmountSet := TRUE;
                           END;
                            }

    { 31  ;2   ;Field     ;
                Name=invoiceDiscountValue;
                CaptionML=[ENU=invoiceDiscountValue;
                           ESM=invoiceDiscountValue;
                           FRC=invoiceDiscountValue;
                           ENC=invoiceDiscountValue];
                ApplicationArea=#All;
                SourceExpr="Invoice Discount Value";
                OnValidate=BEGIN
                             CheckStatus;
                             RegisterFieldSet(FIELDNO("Invoice Discount Value"));
                             DiscountAmountSet := TRUE;
                           END;
                            }

    { 32  ;2   ;Field     ;
                Name=remainingAmount;
                CaptionML=[ENU=remainingAmount;
                           ESM=Importe restante;
                           FRC=Montant restant;
                           ENC=remainingAmount];
                ToolTipML=[ENU=Specifies the Status for the Invoice;
                           ESM=Especifica el estado de la factura;
                           FRC=Sp‚cifie l'‚tat de la facture;
                           ENC=Specifies the Status for the Invoice];
                ApplicationArea=#All;
                SourceExpr=RemainingAmountVar;
                Editable=FALSE }

    { 34  ;2   ;Field     ;
                Name=lastEmailSentStatus;
                CaptionML=[@@@={Locked};
                           ENU=lastEmailSentStatus;
                           ESM=lastEmailSentStatus;
                           FRC=lastEmailSentStatus;
                           ENC=lastEmailSentStatus];
                ToolTipML=[ENU=Specifies the status of the last sent email, Not Sent, In Process, Finished, or Error.;
                           ESM=Especifica el estado del £ltimo correo electr¢nico enviado (No enviado, En proceso, Finalizado o Error).;
                           FRC=Sp‚cifie l'‚tat du dernier courriel envoy‚ÿ: Non envoy‚, En cours, Termin‚ ou Erreur.;
                           ENC=Specifies the status of the last sent email, Not Sent, In Process, Finished, or Error.];
                ApplicationArea=#All;
                SourceExpr=LastEmailSentStatus;
                Editable=FALSE }

    { 35  ;2   ;Field     ;
                Name=lastEmailSentTime;
                CaptionML=[@@@={Locked};
                           ENU=lastEmailSentTime;
                           ESM=lastEmailSentTime;
                           FRC=lastEmailSentTime;
                           ENC=lastEmailSentTime];
                ToolTipML=[ENU=Specifies the time that the last email was sent.;
                           ESM=Especifica la hora de env¡o del £ltimo correo electr¢nico.;
                           FRC=Sp‚cifie l'heure … laquelle le dernier courriel a ‚t‚ envoy‚.;
                           ENC=Specifies the time that the last email was sent.];
                ApplicationArea=#All;
                SourceExpr=LastEmailSentTime;
                Editable=FALSE }

    { 12  ;2   ;Field     ;
                Name=isTest;
                CaptionML=[@@@={Locked};
                           ENU=isTest;
                           ESM=isTest;
                           FRC=isTest;
                           ENC=isTest];
                ToolTipML=[ENU=Specifies if the sales invoice is a test invoice.;
                           ESM=Especifica si la factura de ventas es una factura de prueba.;
                           FRC=Sp‚cifie si la facture vente est une facture de test.;
                           ENC=Specifies if the sales invoice is a test invoice.];
                ApplicationArea=#All;
                SourceExpr=IsTest;
                Editable=FALSE }

    { 37  ;2   ;Field     ;
                Name=isCustomerBlocked;
                CaptionML=[@@@={Locked};
                           ENU=isCustomerBlocked;
                           ESM=isCustomerBlocked;
                           FRC=isCustomerBlocked;
                           ENC=isCustomerBlocked];
                ToolTipML=[ENU=Specifies if the customer is blocked.;
                           ESM=Especifica si el cliente est  bloqueado.;
                           FRC=Sp‚cifie si le client est bloqu‚.;
                           ENC=Specifies if the customer is blocked.];
                ApplicationArea=#All;
                SourceExpr=IsCustomerBlocked;
                Editable=FALSE }

    { 29  ;2   ;Part      ;
                Name=Payments;
                CaptionML=[@@@={Locked};
                           ENU=Payments;
                           ESM=Payments;
                           FRC=Payments;
                           ENC=Payments];
                ApplicationArea=#All;
                SubPageLink=Applies-to Invoice Id=FIELD(Id);
                PagePartID=Page2831;
                PartType=Page }

  }
  CODE
  {
    VAR
      CannotChangeIDErr@1004 : TextConst '@@@={Locked};ENU=The id cannot be changed.;ESM=The id cannot be changed.;FRC=The id cannot be changed.;ENC=The id cannot be changed.';
      TempFieldBuffer@1001 : TEMPORARY Record 8450;
      Customer@1003 : Record 18;
      DummySalesLine@1017 : Record 37;
      NativeAPILanguageHandler@1040 : Codeunit 2850;
      BillingPostalAddressJSONText@1002 : Text;
      CustomerEmail@1010 : Text;
      SalesInvoiceLinesJSON@1006 : Text;
      PreviousSalesInvoiceLinesJSON@1009 : Text;
      CouponsJSON@1022 : Text;
      PreviousCouponsJSON@1023 : Text;
      AttachmentsJSON@1025 : Text;
      PreviousAttachmentsJSON@1026 : Text;
      TaxAreaDisplayName@1035 : Text;
      BillingPostalAddressSet@1000 : Boolean;
      CannotFindCustomerErr@1005 : TextConst '@@@={Locked};ENU=The customer cannot be found.;ESM=The customer cannot be found.;FRC=The customer cannot be found.;ENC=The customer cannot be found.';
      ContactIdHasToHaveValueErr@1007 : TextConst 'ENU=Contact Id must have a value set.;ESM=El Id. de contacto debe tener un valor establecido.;FRC=Le code du contact doit avoir une valeur d‚finie.;ENC=Contact Id must have a value set.';
      SalesLinesSet@1008 : Boolean;
      CouponsSet@1024 : Boolean;
      DiscountAmountSet@1013 : Boolean;
      IsAttachmentsSet@1027 : Boolean;
      InvoiceDiscountAmount@1011 : Decimal;
      CustomerNotProvidedErr@1012 : TextConst '@@@={Locked};ENU=A customerNumber or a customerID must be provided.;ESM=A customerNumber or a customerID must be provided.;FRC=A customerNumber or a customerID must be provided.;ENC=A customerNumber or a customerID must be provided.';
      InvoiceDiscountPct@1030 : Decimal;
      WorkDescription@1014 : Text;
      NoteForCustomerSet@1015 : Boolean;
      CannotChangeWorkDescriptionOnPostedInvoiceErr@1016 : TextConst 'ENU=The Note for customer cannot be changed on the sent invoice.;ESM=No se puede cambiar el campo Nota para el cliente en la factura enviada.;FRC=Il n''est pas possible de modifier la Note pour le client sur la facture envoy‚e.;ENC=The Note for customer cannot be changed on the sent invoice.';
      DocumentDateSet@1018 : Boolean;
      DocumentDateVar@1019 : Date;
      DueDateSet@1020 : Boolean;
      DueDateVar@1021 : Date;
      PostedInvoiceActionErr@1041 : TextConst 'ENU=The action can be applied to a posted invoice only.;ESM=La acci¢n se puede aplicar a una factura registrada solamente.;FRC=L''action peut uniquement ˆtre appliqu‚e … une facture report‚e.;ENC=The action can be applied to a posted invoice only.';
      DraftInvoiceActionErr@1042 : TextConst 'ENU=The action can be applied to a draft invoice only.;ESM=La acci¢n se puede aplicar a un borrador de factura solamente.;FRC=L''action peut uniquement ˆtre appliqu‚e … une facture provisoire.;ENC=The action can be applied to a draft invoice only.';
      CannotFindInvoiceErr@1043 : TextConst 'ENU=The invoice cannot be found.;ESM=No se encuentra la factura.;FRC=Impossible de trouver la facture.;ENC=The invoice cannot be found.';
      CancelingInvoiceFailedCreditMemoCreatedAndPostedErr@1046 : TextConst '@@@=%1 - Error Message;ENU=Canceling the invoice failed because of the following error: \\%1\\A credit memo is posted.;ESM=Error al cancelar la factura debido al siguiente error: \\%1\\Se registra una nota de cr‚dito.;FRC=L''annulation de la facture a ‚chou‚ en raison de l''erreur suivanteÿ: \\%1\\Une note de cr‚dit est report‚e.;ENC=Cancelling the invoice failed because of the following error: \\%1\\A credit memo is posted.';
      CancelingInvoiceFailedCreditMemoCreatedButNotPostedErr@1047 : TextConst '@@@=%1 - Error Message;ENU=Canceling the invoice failed because of the following error: \\%1\\A credit memo is created but not posted.;ESM=Error al cancelar la factura debido al siguiente error: \\%1\\Se crea una nota de cr‚dito, pero no se la registra.;FRC=L''annulation de la facture a ‚chou‚ en raison de l''erreur suivanteÿ: \\%1\\Une note de cr‚dit est cr‚‚e mais non report‚e.;ENC=Cancelling the invoice failed because of the following error: \\%1\\A credit memo is created but not posted.';
      CancelingInvoiceFailedNothingCreatedErr@1048 : TextConst '@@@=%1 - Error Message;ENU=Canceling the invoice failed because of the following error: \\%1.;ESM=No se pudo cancelar la factura debido al siguiente error: \\%1.;FRC=L''annulation de la facture a ‚chou‚ en raison de l''erreur suivanteÿ: \\%1.;ENC=Cancelling the invoice failed because of the following error: \\%1.';
      EmptyEmailErr@1049 : TextConst 'ENU=The send-to email is empty. Specify email either for the customer or for the invoice in email preview.;ESM=El correo electr¢nico del destinatario est  vac¡o. Especifique el correo electr¢nico del cliente o de la factura en la vista previa de correo electr¢nico.;FRC=Le courriel destinataire est vide. Sp‚cifiez le courriel pour le client ou pour la facture dans l''aper‡u du courriel.;ENC=The send-to email is empty. Specify email either for the customer or for the invoice in email preview.';
      AlreadyCanceledErr@1031 : TextConst 'ENU=The invoice cannot be canceled because it has already been canceled.;ESM=No se puede cancelar la factura porque ya se ha cancelado.;FRC=La facture ne peut pas ˆtre annul‚e, car elle a d‚j… ‚t‚ annul‚e.;ENC=The invoice cannot be cancelled because it has already been cancelled.';
      InvoiceDiscountPctMustBePositiveErr@1028 : TextConst 'ENU=Invoice discount percentage must be positive.;ESM=El porcentaje de descuento en factura debe ser positivo.;FRC=Le pourcentage d''escompte facture doit ˆtre positif.;ENC=Invoice discount percentage must be positive.';
      InvoiceDiscountPctMustBeBelowHundredErr@1029 : TextConst 'ENU=Invoice discount percentage must be below 100.;ESM=El porcentaje de descuento en factura debe ser inferior a 100.;FRC=Le pourcentage d''escompte facture doit ˆtre inf‚rieur … 100.;ENC=Invoice discount percentage must be below 100.';
      InvoiceDiscountAmtMustBePositiveErr@1033 : TextConst 'ENU=Invoice discount must be positive.;ESM=El descuento en factura debe ser positivo.;FRC=L''escompte facture doit ˆtre positif.;ENC=Invoice discount must be positive.';
      RemainingAmountVar@1034 : Decimal;
      CustomerIdSet@1037 : Boolean;
      LastEmailSentTime@1036 : DateTime;
      CannotModifyPostedInvioceErr@1038 : TextConst 'ENU=The invoice has been posted and can no longer be modified. You are only allowed to change the attachments.;ESM=La factura se ha registrado y ya no se puede modificar. Solo se permite cambiar los archivos adjuntos.;FRC=La facture a ‚t‚ report‚e et ne peut plus ˆtre modifi‚e. Vous ˆtes uniquement autoris‚ … modifier les piŠces jointes.;ENC=The invoice has been posted and can no longer be modified. You are only allowed to change the attachments.';
      LastEmailSentStatus@1039 : 'Not Sent,In Process,Finished,Error';
      AggregateParentIsMissingErr@1044 : TextConst 'ENU=Please try the operation again. If the error persists, please contact support.;ESM=Vuelva a intentar la operaci¢n. Si el error persiste, p¢ngase en contacto con el soporte t‚cnico.;FRC=Veuillez recommencer l''op‚ration. Si l''erreur persiste, contactez le support.;ENC=Please try the operation again. If the error persists, please contact support.';
      CurrencyCodeTxt@1052 : Text;
      LCYCurrencyCode@1045 : Code[10];
      IsCustomerBlocked@1032 : Boolean;

    LOCAL PROCEDURE SetAttachmentsJSON@37();
    VAR
      NativeAttachments@1004 : Codeunit 2820;
    BEGIN
      AttachmentsJSON := NativeAttachments.GenerateAttachmentsJSON(Id);
      PreviousAttachmentsJSON := AttachmentsJSON;
    END;

    LOCAL PROCEDURE SetCalculatedFields@6(VAR SalesHeader@1006 : Record 36;VAR SalesInvoiceHeader@1004 : Record 112);
    VAR
      TempSalesInvoiceLineAggregate@1002 : TEMPORARY Record 5476;
      DummyNativeAPITaxSetup@1005 : Record 2850;
      GraphMgtGeneralTools@1007 : Codeunit 5465;
      GraphMgtSalesInvoice@1000 : Codeunit 5475;
      NativeEDMTypes@1001 : Codeunit 2801;
      NativeCoupons@1003 : Codeunit 2815;
    BEGIN
      DocumentDateVar := "Document Date";
      DueDateVar := "Due Date";
      BillingPostalAddressJSONText := GraphMgtSalesInvoice.BillToCustomerAddressToJSON(Rec);
      CurrencyCodeTxt := GraphMgtGeneralTools.TranslateNAVCurrencyCodeToCurrencyCode(LCYCurrencyCode,"Currency Code");

      IF "Sell-to Customer No." <> '' THEN
        IF Customer.GET("Sell-to Customer No.") THEN BEGIN
          CustomerEmail := Customer."E-Mail";
          IsCustomerBlocked := Customer.IsBlocked
        END ELSE BEGIN
          IsCustomerBlocked := FALSE;
          CustomerEmail := '';
        END;

      LoadLines(TempSalesInvoiceLineAggregate,Rec);
      SalesInvoiceLinesJSON :=
        NativeEDMTypes.WriteSalesLinesJSON(TempSalesInvoiceLineAggregate);
      PreviousSalesInvoiceLinesJSON := SalesInvoiceLinesJSON;

      CouponsJSON := NativeCoupons.WriteCouponsJSON(DummySalesLine."Document Type"::Invoice,"No.",Posted);
      PreviousCouponsJSON := CouponsJSON;

      SetAttachmentsJSON;
      TaxAreaDisplayName := DummyNativeAPITaxSetup.GetTaxAreaDisplayName("Tax Area ID");
      GetNoteForCustomer(SalesHeader,SalesInvoiceHeader);
      GetRemainingAmount;
      GetLastEmailSentFields(SalesHeader,SalesInvoiceHeader);
    END;

    LOCAL PROCEDURE ClearCalculatedFields@10();
    BEGIN
      CLEAR(BillingPostalAddressJSONText);
      CLEAR(SalesInvoiceLinesJSON);
      CLEAR(PreviousSalesInvoiceLinesJSON);
      CLEAR(SalesLinesSet);
      CLEAR(CouponsJSON);
      CLEAR(PreviousCouponsJSON);
      CLEAR(CouponsSet);
      CLEAR(AttachmentsJSON);
      CLEAR(PreviousAttachmentsJSON);
      CLEAR(IsAttachmentsSet);
      CLEAR(WorkDescription);
      CLEAR(DueDateSet);
      CLEAR(CurrencyCodeTxt);
      "Due Date" := 010199D;
      CLEAR(DocumentDateSet);
      CLEAR(DocumentDateVar);
      CLEAR(RemainingAmountVar);
      CLEAR(TaxAreaDisplayName);
      CLEAR(LastEmailSentTime);
      CLEAR(LastEmailSentStatus);
      TempFieldBuffer.DELETEALL;
    END;

    LOCAL PROCEDURE RegisterFieldSet@11(FieldNo@1000 : Integer);
    VAR
      LastOrderNo@1001 : Integer;
    BEGIN
      LastOrderNo := 1;
      IF TempFieldBuffer.FINDLAST THEN
        LastOrderNo := TempFieldBuffer.Order + 1;

      CLEAR(TempFieldBuffer);
      TempFieldBuffer.Order := LastOrderNo;
      TempFieldBuffer."Table ID" := DATABASE::"Sales Invoice Entity Aggregate";
      TempFieldBuffer."Field ID" := FieldNo;
      TempFieldBuffer.INSERT;
    END;

    LOCAL PROCEDURE ProcessBillingPostalAddress@5();
    VAR
      GraphMgtSalesInvoice@1000 : Codeunit 5475;
    BEGIN
      IF NOT BillingPostalAddressSet THEN
        EXIT;

      GraphMgtSalesInvoice.ProcessComplexTypes(Rec,BillingPostalAddressJSONText);

      IF xRec."Sell-to Address" <> "Sell-to Address" THEN
        RegisterFieldSet(FIELDNO("Sell-to Address"));

      IF xRec."Sell-to Address 2" <> "Sell-to Address 2" THEN
        RegisterFieldSet(FIELDNO("Sell-to Address 2"));

      IF xRec."Sell-to City" <> "Sell-to City" THEN
        RegisterFieldSet(FIELDNO("Sell-to City"));

      IF xRec."Sell-to Country/Region Code" <> "Sell-to Country/Region Code" THEN
        RegisterFieldSet(FIELDNO("Sell-to Country/Region Code"));

      IF xRec."Sell-to Post Code" <> "Sell-to Post Code" THEN
        RegisterFieldSet(FIELDNO("Sell-to Post Code"));

      IF xRec."Sell-to County" <> "Sell-to County" THEN
        RegisterFieldSet(FIELDNO("Sell-to County"));
    END;

    LOCAL PROCEDURE UpdateCustomerFromGraphContactId@2(VAR Customer@1001 : Record 18);
    VAR
      O365SalesInvoiceMgmt@1002 : Codeunit 2310;
      UpdateCustomer@1000 : Boolean;
    BEGIN
      UpdateCustomer := "Sell-to Customer No." = '';
      IF NOT UpdateCustomer THEN BEGIN
        TempFieldBuffer.RESET;
        TempFieldBuffer.SETRANGE("Field ID",FIELDNO("Customer Id"));
        UpdateCustomer := NOT TempFieldBuffer.FINDFIRST;
        TempFieldBuffer.RESET;
      END;

      IF UpdateCustomer THEN BEGIN
        VALIDATE("Customer Id",Customer.Id);
        VALIDATE("Sell-to Customer No.",Customer."No.");
        RegisterFieldSet(FIELDNO("Customer Id"));
        RegisterFieldSet(FIELDNO("Sell-to Customer No."));
      END;

      O365SalesInvoiceMgmt.EnforceCustomerTemplateIntegrity(Customer);
    END;

    LOCAL PROCEDURE LoadLines@1(VAR TempSalesInvoiceLineAggregate@1000 : TEMPORARY Record 5476;VAR SalesInvoiceEntityAggregate@1001 : Record 5475);
    VAR
      SalesInvoiceAggregator@1002 : Codeunit 5477;
    BEGIN
      TempSalesInvoiceLineAggregate.SETRANGE("Document Id",SalesInvoiceEntityAggregate.Id);
      SalesInvoiceAggregator.LoadLines(TempSalesInvoiceLineAggregate,TempSalesInvoiceLineAggregate.GETFILTER("Document Id"));
    END;

    LOCAL PROCEDURE UpdateLines@4();
    VAR
      TempSalesInvoiceLineAggregate@1002 : TEMPORARY Record 5476;
      SalesInvoiceAggregator@1000 : Codeunit 5477;
      NativeEDMTypes@1001 : Codeunit 2801;
    BEGIN
      IF NOT SalesLinesSet THEN
        EXIT;

      NativeEDMTypes.ParseSalesLinesJSON(
        DummySalesLine."Document Type"::Invoice,SalesInvoiceLinesJSON,TempSalesInvoiceLineAggregate,Id);
      TempSalesInvoiceLineAggregate.SETRANGE("Document Id",Id);
      SalesInvoiceAggregator.PropagateMultipleLinesUpdate(TempSalesInvoiceLineAggregate);
      FIND;
    END;

    LOCAL PROCEDURE UpdateDiscount@13();
    VAR
      SalesHeader@1002 : Record 36;
      SalesLine@1004 : Record 37;
      TotalSalesLine@1006 : Record 37;
      CustInvDisc@1008 : Record 19;
      SalesInvoiceAggregator@1000 : Codeunit 5477;
      SalesCalcDiscountByType@1001 : Codeunit 56;
      O365Discounts@1003 : Codeunit 2155;
      DocumentTotals@1005 : Codeunit 57;
      VatAmount@1007 : Decimal;
    BEGIN
      IF Posted THEN
        EXIT;

      IF SalesLinesSet AND (NOT DiscountAmountSet) THEN BEGIN
        SalesInvoiceAggregator.RedistributeInvoiceDiscounts(Rec);
        EXIT;
      END;

      IF NOT DiscountAmountSet THEN
        EXIT;

      CASE "Invoice Discount Calculation" OF
        "Invoice Discount Calculation"::"%":
          BEGIN
            IF "Invoice Discount Value" < 0 THEN
              ERROR(InvoiceDiscountPctMustBePositiveErr);
            IF "Invoice Discount Value" > 100 THEN
              ERROR(InvoiceDiscountPctMustBeBelowHundredErr);
            InvoiceDiscountPct := "Invoice Discount Value";
          END;
        "Invoice Discount Calculation"::Amount:
          BEGIN
            InvoiceDiscountAmount := "Invoice Discount Value";
            IF "Invoice Discount Value" < 0 THEN
              ERROR(InvoiceDiscountAmtMustBePositiveErr);
          END;
      END;

      SalesHeader.GET("Document Type"::Invoice,"No.");
      IF InvoiceDiscountPct <> 0 THEN BEGIN
        O365Discounts.ApplyInvoiceDiscountPercentage(SalesHeader,InvoiceDiscountPct);
        SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
        SalesLine.SETRANGE("Document No.",SalesHeader."No.");
        IF SalesLine.FINDFIRST THEN BEGIN
          SalesInvoiceAggregator.RedistributeInvoiceDiscounts(Rec);
          DocumentTotals.CalculateSalesTotals(TotalSalesLine,VatAmount,SalesLine);
          "Invoice Discount Amount" := TotalSalesLine."Inv. Discount Amount";
          RegisterFieldSet(FIELDNO("Invoice Discount Amount"));
        END;
      END ELSE BEGIN
        CustInvDisc.SETRANGE(Code,"No.");
        CustInvDisc.DELETEALL;
        SalesCalcDiscountByType.ApplyInvDiscBasedOnAmt(InvoiceDiscountAmount,SalesHeader);
        SalesInvoiceAggregator.RedistributeInvoiceDiscounts(Rec);
      END;
    END;

    LOCAL PROCEDURE UpdateCoupons@14();
    VAR
      NativeEDMTypes@1000 : Codeunit 2801;
    BEGIN
      IF NOT CouponsSet THEN
        EXIT;

      NativeEDMTypes.ParseCouponsJSON("Contact Graph Id",DummySalesLine."Document Type"::Invoice,"No.",CouponsJSON);
    END;

    LOCAL PROCEDURE UpdateAttachments@7();
    VAR
      NativeAttachments@1001 : Codeunit 2820;
    BEGIN
      IF NOT IsAttachmentsSet THEN
        EXIT;

      NativeAttachments.UpdateAttachments(Id,AttachmentsJSON,PreviousAttachmentsJSON);
    END;

    LOCAL PROCEDURE CheckCustomer@3();
    VAR
      BlankGUID@1000 : GUID;
    BEGIN
      IF ("Sell-to Customer No." = '') AND
         ("Customer Id" = BlankGUID)
      THEN
        ERROR(CustomerNotProvidedErr);
    END;

    LOCAL PROCEDURE CheckStatus@28();
    BEGIN
      IF Posted THEN
        ERROR(CannotModifyPostedInvioceErr);
    END;

    LOCAL PROCEDURE GetNoteForCustomer@9(VAR SalesHeader@1000 : Record 36;VAR SalesInvoiceHeader@1001 : Record 112);
    BEGIN
      IF Posted THEN
        WorkDescription := SalesInvoiceHeader.GetWorkDescriptionWorkDescriptionCalculated
      ELSE
        WorkDescription := SalesHeader.GetWorkDescriptionWorkDescriptionCalculated;
    END;

    LOCAL PROCEDURE GetLastEmailSentFields@23(VAR SalesHeader@1003 : Record 36;VAR SalesInvoiceHeader@1002 : Record 112);
    BEGIN
      IF Posted THEN BEGIN
        LastEmailSentTime := SalesInvoiceHeader."Last Email Sent Time";
        LastEmailSentStatus := SalesInvoiceHeader."Last Email Sent Status";
      END ELSE BEGIN
        LastEmailSentTime := SalesHeader."Last Email Sent Time";
        LastEmailSentStatus := SalesHeader."Last Email Sent Status";
      END;
    END;

    LOCAL PROCEDURE GetRemainingAmount@16();
    VAR
      SalesInvoiceHeader@1000 : Record 112;
    BEGIN
      RemainingAmountVar := "Amount Including VAT";
      IF Posted THEN
        IF SalesInvoiceHeader.GET("No.") THEN BEGIN
          IF IsInvoiceCanceled THEN BEGIN
            RemainingAmountVar := 0;
            EXIT;
          END;

          RemainingAmountVar := SalesInvoiceHeader.GetRemainingAmount;
        END;
    END;

    LOCAL PROCEDURE SetNoteForCustomer@22();
    VAR
      SalesHeader@1000 : Record 36;
    BEGIN
      IF NOT NoteForCustomerSet THEN
        EXIT;

      IF Posted THEN
        ERROR(CannotChangeWorkDescriptionOnPostedInvoiceErr);

      SalesHeader.GET(SalesHeader."Document Type"::Invoice,"No.");
      SalesHeader.SetWorkDescription(WorkDescription);
      SalesHeader.MODIFY(TRUE);
      FIND;
    END;

    LOCAL PROCEDURE SetDates@8();
    VAR
      SalesInvoiceAggregator@1000 : Codeunit 5477;
    BEGIN
      IF NOT (DueDateSet OR DocumentDateSet) THEN
        EXIT;

      TempFieldBuffer.RESET;
      TempFieldBuffer.DELETEALL;

      IF DocumentDateSet THEN BEGIN
        "Document Date" := DocumentDateVar;
        "Posting Date" := DocumentDateVar;
        RegisterFieldSet(FIELDNO("Document Date"));
        RegisterFieldSet(FIELDNO("Posting Date"));
      END;

      IF DueDateSet THEN BEGIN
        "Due Date" := DueDateVar;
        RegisterFieldSet(FIELDNO("Due Date"));
      END;

      SalesInvoiceAggregator.PropagateOnModify(Rec,TempFieldBuffer);
      FIND;
    END;

    LOCAL PROCEDURE GetPostedInvoice@35(VAR SalesInvoiceHeader@1000 : Record 112);
    BEGIN
      IF NOT Posted THEN
        ERROR(PostedInvoiceActionErr);

      SalesInvoiceHeader.SETRANGE(Id,Id);
      IF NOT SalesInvoiceHeader.FINDFIRST THEN
        ERROR(CannotFindInvoiceErr);
    END;

    LOCAL PROCEDURE GetDraftInvoice@36(VAR SalesHeader@1000 : Record 36);
    BEGIN
      IF Posted THEN
        ERROR(DraftInvoiceActionErr);

      SalesHeader.SETRANGE(Id,Id);
      IF NOT SalesHeader.FINDFIRST THEN
        ERROR(CannotFindInvoiceErr);
    END;

    LOCAL PROCEDURE CheckSendToEmailAddress@21(DocumentNo@1000 : Code[20]);
    BEGIN
      IF GetSendToEmailAddress(DocumentNo) = '' THEN
        ERROR(EmptyEmailErr);
    END;

    LOCAL PROCEDURE GetSendToEmailAddress@26(DocumentNo@1001 : Code[20]) : Text[250];
    VAR
      EmailAddress@1000 : Text[250];
    BEGIN
      EmailAddress := GetDocumentEmailAddress(DocumentNo);
      IF EmailAddress <> '' THEN
        EXIT(EmailAddress);
      EmailAddress := GetCustomerEmailAddress;
      EXIT(EmailAddress);
    END;

    LOCAL PROCEDURE GetCustomerEmailAddress@24() : Text[250];
    BEGIN
      IF NOT Customer.GET("Sell-to Customer No.") THEN
        EXIT('');
      EXIT(Customer."E-Mail");
    END;

    LOCAL PROCEDURE GetDocumentEmailAddress@58(DocumentNo@1000 : Code[20]) : Text[250];
    VAR
      EmailParameter@1002 : Record 9510;
    BEGIN
      IF NOT EmailParameter.GET(DocumentNo,"Document Type",EmailParameter."Parameter Type"::Address) THEN
        EXIT('');
      EXIT(EmailParameter."Parameter Value");
    END;

    LOCAL PROCEDURE CheckInvoiceCanBeCanceled@32(VAR SalesInvoiceHeader@1000 : Record 112);
    VAR
      CorrectPostedSalesInvoice@1001 : Codeunit 1303;
    BEGIN
      IF IsInvoiceCanceled THEN
        ERROR(AlreadyCanceledErr);
      CorrectPostedSalesInvoice.TestCorrectInvoiceIsAllowed(SalesInvoiceHeader,TRUE);
    END;

    LOCAL PROCEDURE IsInvoiceCanceled@25() : Boolean;
    BEGIN
      EXIT(Status = Status::Canceled);
    END;

    LOCAL PROCEDURE PostInvoice@20(VAR SalesHeader@1001 : Record 36;VAR SalesInvoiceHeader@1000 : Record 112);
    VAR
      DummyO365SalesDocument@1003 : Record 2103;
      LinesInstructionMgt@1005 : Codeunit 1320;
      O365SendResendInvoice@1002 : Codeunit 2104;
      PreAssignedNo@1006 : Code[20];
    BEGIN
      O365SendResendInvoice.CheckDocumentIfNoItemsExists(SalesHeader,FALSE,DummyO365SalesDocument);
      LinesInstructionMgt.SalesCheckAllLinesHaveQuantityAssigned(SalesHeader);
      PreAssignedNo := SalesHeader."No.";
      SalesHeader.SendToPosting(CODEUNIT::"Sales-Post");
      SalesInvoiceHeader.SETCURRENTKEY("Pre-Assigned No.");
      SalesInvoiceHeader.SETRANGE("Pre-Assigned No.",PreAssignedNo);
      SalesInvoiceHeader.FINDFIRST;
    END;

    LOCAL PROCEDURE SendPostedInvoice@34(VAR SalesInvoiceHeader@1000 : Record 112);
    VAR
      O365SetupEmail@1001 : Codeunit 2135;
      O365SalesEmailManagement@1002 : Codeunit 2151;
    BEGIN
      O365SetupEmail.SilentSetup;
      CheckSendToEmailAddress(SalesInvoiceHeader."No.");
      O365SalesEmailManagement.NativeAPISaveEmailBodyText(Id);

      CheckAttachmentsSize(SalesInvoiceHeader);

      SalesInvoiceHeader.SETRECFILTER;
      SalesInvoiceHeader.EmailRecords(FALSE);
    END;

    LOCAL PROCEDURE SendDraftInvoice@15(VAR SalesHeader@1000 : Record 36);
    VAR
      DummyO365SalesDocument@1003 : Record 2103;
      LinesInstructionMgt@1002 : Codeunit 1320;
      O365SendResendInvoice@1001 : Codeunit 2104;
      O365SetupEmail@1004 : Codeunit 2135;
      O365SalesEmailManagement@1005 : Codeunit 2151;
    BEGIN
      O365SendResendInvoice.CheckDocumentIfNoItemsExists(SalesHeader,FALSE,DummyO365SalesDocument);
      LinesInstructionMgt.SalesCheckAllLinesHaveQuantityAssigned(SalesHeader);
      O365SetupEmail.SilentSetup;
      CheckSendToEmailAddress(SalesHeader."No.");

      CheckAttachmentsSize(SalesHeader);

      O365SalesEmailManagement.NativeAPISaveEmailBodyText(Id);
      SalesHeader.SETRECFILTER;
      SalesHeader.EmailRecords(FALSE);
    END;

    LOCAL PROCEDURE SendCanceledInvoice@41(VAR SalesInvoiceHeader@1000 : Record 112);
    VAR
      JobQueueEntry@1001 : Record 472;
      O365SetupEmail@1002 : Codeunit 2135;
      O365SalesEmailManagement@1003 : Codeunit 2151;
      O365SalesCancelInvoice@1005 : Codeunit 2103;
      GraphMail@1004 : Codeunit 405;
    BEGIN
      O365SetupEmail.SilentSetup;
      CheckSendToEmailAddress(SalesInvoiceHeader."No.");
      O365SalesEmailManagement.NativeAPISaveEmailBodyText(Id);

      CheckAttachmentsSize(SalesInvoiceHeader);

      JobQueueEntry.INIT;
      JobQueueEntry."Object Type to Run" := JobQueueEntry."Object Type to Run"::Codeunit;
      JobQueueEntry."Object ID to Run" := CODEUNIT::"O365 Sales Cancel Invoice";
      JobQueueEntry."Maximum No. of Attempts to Run" := 3;
      JobQueueEntry."Record ID to Process" := SalesInvoiceHeader.RECORDID;

      IF GraphMail.IsEnabled AND GraphMail.HasConfiguration THEN
        O365SalesCancelInvoice.SendInvoiceCancelationEmail(SalesInvoiceHeader)
      ELSE
        CODEUNIT.RUN(CODEUNIT::"Job Queue - Enqueue",JobQueueEntry);
    END;

    LOCAL PROCEDURE CancelInvoice@39(VAR SalesInvoiceHeader@1000 : Record 112);
    VAR
      SalesCrMemoHeader@1007 : Record 114;
      SalesHeader@1001 : Record 36;
    BEGIN
      GetPostedInvoice(SalesInvoiceHeader);
      CheckInvoiceCanBeCanceled(SalesInvoiceHeader);
      IF NOT CODEUNIT.RUN(CODEUNIT::"Correct Posted Sales Invoice",SalesInvoiceHeader) THEN BEGIN
        SalesCrMemoHeader.SETRANGE("Applies-to Doc. No.",SalesInvoiceHeader."No.");
        IF SalesCrMemoHeader.FINDFIRST THEN
          ERROR(CancelingInvoiceFailedCreditMemoCreatedAndPostedErr,GETLASTERRORTEXT);
        SalesHeader.SETRANGE("Applies-to Doc. No.",SalesInvoiceHeader."No.");
        IF SalesHeader.FINDFIRST THEN
          ERROR(CancelingInvoiceFailedCreditMemoCreatedButNotPostedErr,GETLASTERRORTEXT);
        ERROR(CancelingInvoiceFailedNothingCreatedErr,GETLASTERRORTEXT);
      END;
    END;

    LOCAL PROCEDURE SetActionResponse@47(VAR ActionContext@1004 : DotNet "'Microsoft.Dynamics.Nav.Ncl, Version=13.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.Runtime.WebServiceActionContext";InvoiceId@1000 : GUID);
    VAR
      ODataActionManagement@1003 : Codeunit 6711;
    BEGIN
      ODataActionManagement.AddKey(FIELDNO(Id),InvoiceId);
      ODataActionManagement.SetDeleteResponseLocation(ActionContext,PAGE::"Native - Sales Inv. Entity");
    END;

    [ServiceEnabled]
    [External]
    PROCEDURE Post@18(VAR ActionContext@1000 : DotNet "'Microsoft.Dynamics.Nav.Ncl, Version=13.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.Runtime.WebServiceActionContext");
    VAR
      SalesHeader@1001 : Record 36;
      SalesInvoiceHeader@1002 : Record 112;
    BEGIN
      GetDraftInvoice(SalesHeader);
      PostInvoice(SalesHeader,SalesInvoiceHeader);
      SetActionResponse(ActionContext,SalesInvoiceHeader.Id);
    END;

    [ServiceEnabled]
    [External]
    PROCEDURE PostAndSend@33(VAR ActionContext@1000 : DotNet "'Microsoft.Dynamics.Nav.Ncl, Version=13.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.Runtime.WebServiceActionContext");
    VAR
      SalesHeader@1005 : Record 36;
      SalesInvoiceHeader@1002 : Record 112;
    BEGIN
      GetDraftInvoice(SalesHeader);
      PostInvoice(SalesHeader,SalesInvoiceHeader);
      COMMIT;
      SendPostedInvoice(SalesInvoiceHeader);
      SetActionResponse(ActionContext,SalesInvoiceHeader.Id);
    END;

    [ServiceEnabled]
    [External]
    PROCEDURE Send@17(VAR ActionContext@1000 : DotNet "'Microsoft.Dynamics.Nav.Ncl, Version=13.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.Runtime.WebServiceActionContext");
    VAR
      SalesHeader@1005 : Record 36;
      SalesInvoiceHeader@1002 : Record 112;
    BEGIN
      IF Posted THEN BEGIN
        GetPostedInvoice(SalesInvoiceHeader);
        IF IsInvoiceCanceled THEN
          SendCanceledInvoice(SalesInvoiceHeader)
        ELSE
          SendPostedInvoice(SalesInvoiceHeader);
        SetActionResponse(ActionContext,SalesInvoiceHeader.Id);
        EXIT;
      END;
      GetDraftInvoice(SalesHeader);
      SendDraftInvoice(SalesHeader);
      SetActionResponse(ActionContext,SalesHeader.Id);
    END;

    [ServiceEnabled]
    [External]
    PROCEDURE Cancel@19(VAR ActionContext@1000 : DotNet "'Microsoft.Dynamics.Nav.Ncl, Version=13.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.Runtime.WebServiceActionContext");
    VAR
      SalesInvoiceHeader@1002 : Record 112;
    BEGIN
      GetPostedInvoice(SalesInvoiceHeader);
      CancelInvoice(SalesInvoiceHeader);
      SetActionResponse(ActionContext,SalesInvoiceHeader.Id);
    END;

    [ServiceEnabled]
    [External]
    PROCEDURE CancelAndSend@51(VAR ActionContext@1000 : DotNet "'Microsoft.Dynamics.Nav.Ncl, Version=13.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.Runtime.WebServiceActionContext");
    VAR
      SalesInvoiceHeader@1002 : Record 112;
    BEGIN
      GetPostedInvoice(SalesInvoiceHeader);
      CancelInvoice(SalesInvoiceHeader);
      SendCanceledInvoice(SalesInvoiceHeader);
      SetActionResponse(ActionContext,SalesInvoiceHeader.Id);
    END;

    LOCAL PROCEDURE CheckAttachmentsSize@91(RecordVariant@1022 : Variant);
    VAR
      IncomingDocumentAttachment@1020 : Record 133;
      O365SalesAttachmentMgt@1021 : Codeunit 2112;
    BEGIN
      O365SalesAttachmentMgt.GetAttachments(RecordVariant,IncomingDocumentAttachment);
      O365SalesAttachmentMgt.AssertIncomingDocumentSizeBelowMax(IncomingDocumentAttachment);
    END;

    BEGIN
    END.
  }
}

